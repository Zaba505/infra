<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zaba505.github.io/infra/pr-preview/pr-629/rd/analysis/google-cloud/><link rel=alternate type=application/rss+xml href=https://zaba505.github.io/infra/pr-preview/pr-629/rd/analysis/google-cloud/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/infra/pr-preview/pr-629/favicons/favicon.ico><link rel=apple-touch-icon href=/infra/pr-preview/pr-629/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/infra/pr-preview/pr-629/favicons/android-192x192.png sizes=192x192><title>Google Cloud Platform Analysis | Zaba505's Home Lab</title><meta name=description content="Technical analysis of Google Cloud Platform capabilities for hosting network boot infrastructure"><meta property="og:url" content="https://zaba505.github.io/infra/pr-preview/pr-629/rd/analysis/google-cloud/"><meta property="og:site_name" content="Zaba505's Home Lab"><meta property="og:title" content="Google Cloud Platform Analysis"><meta property="og:description" content="Technical analysis of Google Cloud Platform capabilities for hosting network boot infrastructure"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Google Cloud Platform Analysis"><meta itemprop=description content="Technical analysis of Google Cloud Platform capabilities for hosting network boot infrastructure"><meta itemprop=dateModified content="2025-11-22T00:34:30+00:00"><meta itemprop=wordCount content="135"><meta name=twitter:card content="summary"><meta name=twitter:title content="Google Cloud Platform Analysis"><meta name=twitter:description content="Technical analysis of Google Cloud Platform capabilities for hosting network boot infrastructure"><link rel=preload href=/infra/pr-preview/pr-629/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css as=style integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><link href=/infra/pr-preview/pr-629/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css rel=stylesheet integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/infra/pr-preview/pr-629/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Zaba505's Home Lab</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/infra/pr-preview/pr-629/offline-search-index.1bced84c264cd8d2082b019bcd501c25.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/infra/pr-preview/pr-629/rd/analysis/google-cloud/>Return to the regular view of this page</a>.</p></div><h1 class=title>Google Cloud Platform Analysis</h1><div class=lead>Technical analysis of Google Cloud Platform capabilities for hosting network boot infrastructure</div><ul><li>1: <a href=#pg-8349b2324a2beea2d0650a6b39802b81>Cloud Storage FUSE (gcsfuse)</a></li><li>2: <a href=#pg-40e0d560582430a6e545597f7b73eb02>GCP Network Boot Protocol Support</a></li><li>3: <a href=#pg-35563ff6a8a7c7f31535b56d4156bd8b>GCP WireGuard VPN Support</a></li></ul><div class=content><p>This section contains detailed analysis of Google Cloud Platform (GCP) for hosting the network boot server infrastructure, evaluating its support for TFTP, HTTP/HTTPS routing, and WireGuard VPN connectivity as required by ADR-0002.</p><h2 id=overview>Overview</h2><p>Google Cloud Platform is Google&rsquo;s suite of cloud computing services, offering compute, storage, networking, and managed services. This analysis focuses on GCP&rsquo;s capabilities to support the network boot architecture decided in <a href=../../adrs/0002-network-boot-architecture/>ADR-0002</a>.</p><h2 id=key-services-evaluated>Key Services Evaluated</h2><ul><li><strong>Compute Engine</strong>: Virtual machine instances for hosting boot server</li><li><strong>Cloud VPN / VPC</strong>: Network connectivity and VPN capabilities</li><li><strong>Cloud Load Balancing</strong>: Layer 4 and Layer 7 load balancing for HTTP/HTTPS</li><li><strong>Cloud NAT</strong>: Network address translation for outbound connectivity</li><li><strong>VPC Network</strong>: Software-defined networking and routing</li></ul><h2 id=documentation-sections>Documentation Sections</h2><ul><li><a href=./network-boot/>Network Boot Support</a> - Analysis of TFTP, HTTP, and HTTPS routing capabilities</li><li><a href=./wireguard/>WireGuard Support</a> - Evaluation of WireGuard VPN integration options</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8349b2324a2beea2d0650a6b39802b81>1 - Cloud Storage FUSE (gcsfuse)</h1><div class=lead>Analysis of Google Cloud Storage FUSE for mounting GCS buckets as local filesystems in network boot infrastructure</div><h2 id=overview>Overview</h2><p>Cloud Storage FUSE (gcsfuse) is a FUSE-based filesystem adapter that allows Google Cloud Storage (GCS) buckets to be mounted and accessed as local filesystems on Linux systems. This enables applications to interact with object storage using standard filesystem operations (open, read, write, etc.) rather than requiring GCS-specific APIs.</p><p><strong>Project</strong>: <a href=https://github.com/GoogleCloudPlatform/gcsfuse>GoogleCloudPlatform/gcsfuse</a>
<strong>License</strong>: Apache 2.0
<strong>Status</strong>: Generally Available (GA)
<strong>Latest Version</strong>: v2.x (as of 2024)</p><h2 id=how-gcsfuse-works>How gcsfuse Works</h2><p>gcsfuse translates filesystem operations into GCS API calls:</p><ol><li><strong>Mount Operation</strong>: <code>gcsfuse bucket-name /mount/point</code> maps a GCS bucket to a local directory</li><li><strong>Directory Structure</strong>: Interprets <code>/</code> in object names as directory separators</li><li><strong>File Operations</strong>: Translates <code>read()</code>, <code>write()</code>, <code>open()</code>, etc. into GCS API requests</li><li><strong>Metadata</strong>: Maintains file attributes (size, modification time) via GCS metadata</li><li><strong>Caching</strong>: Optional stat, type, list, and file caching to reduce API calls</li></ol><p><strong>Example</strong>:</p><ul><li>GCS object: <code>gs://boot-assets/kernels/talos-v1.6.0.img</code></li><li>Mounted path: <code>/mnt/boot-assets/kernels/talos-v1.6.0.img</code></li></ul><h2 id=relevance-to-network-boot-infrastructure>Relevance to Network Boot Infrastructure</h2><p>In the context of <a href=../../adrs/0005-network-boot-infrastructure-gcp.md>ADR-0005 Network Boot Infrastructure</a>, gcsfuse offers a potential approach for serving boot assets from Cloud Storage without custom integration code.</p><h3 id=potential-use-cases>Potential Use Cases</h3><ol><li><strong>Boot Asset Storage</strong>: Mount <code>gs://boot-assets/</code> to <code>/var/lib/boot-server/assets/</code></li><li><strong>Configuration Sync</strong>: Access boot profiles and machine mappings from GCS as local files</li><li><strong>Matchbox Integration</strong>: Mount GCS bucket to <code>/var/lib/matchbox/</code> for assets/profiles/groups</li><li><strong>Simplified Development</strong>: Eliminate custom Cloud Storage SDK integration in boot server code</li></ol><h3 id=architecture-pattern>Architecture Pattern</h3><pre tabindex=0><code>┌─────────────────────────┐
│   Boot Server Process   │
│  (Cloud Run/Compute)    │
└───────────┬─────────────┘
            │ filesystem operations
            │ (read, open, stat)
            ▼
┌─────────────────────────┐
│   gcsfuse mount point   │
│   /var/lib/boot-assets  │
└───────────┬─────────────┘
            │ FUSE layer
            │ (translates to GCS API)
            ▼
┌─────────────────────────┐
│  Cloud Storage Bucket   │
│   gs://boot-assets/     │
└─────────────────────────┘
</code></pre><h2 id=performance-characteristics>Performance Characteristics</h2><h3 id=latency>Latency</h3><ul><li><strong>Much higher latency than local filesystem</strong>: Every operation requires GCS API call(s)</li><li><strong>No default caching</strong>: Without caching enabled, every read re-fetches from GCS</li><li><strong>Network round-trip</strong>: Minimum ~10-50ms latency per operation (depending on region)</li></ul><h3 id=throughput>Throughput</h3><p><strong>Single Large File</strong>:</p><ul><li>Read: ~4.1 MiB/s (individual file), up to 63.3 MiB/s (archive files)</li><li>Write: Comparable to <code>gsutil cp</code> for large files</li><li><strong>With parallel downloads</strong>: Up to 9x faster for single-threaded reads of large files</li></ul><p><strong>Small Files</strong>:</p><ul><li>Poor performance for random I/O on small files</li><li>Bulk operations on many small files create significant bottlenecks</li><li><code>ls</code> on directories with thousands of objects can take minutes</li></ul><p><strong>Concurrent Access</strong>:</p><ul><li>Performance degrades significantly with parallel readers (8 instances: ~30 hours vs 16 minutes with local data)</li><li>Not recommended for high-concurrency scenarios (web servers, NAS)</li></ul><h3 id=performance-improvements-recent-features>Performance Improvements (Recent Features)</h3><ol><li><p><strong>Streaming Writes</strong> (default): Upload data directly to GCS as written</p><ul><li>Up to 40% faster for large sequential writes</li><li>Reduces local disk usage (no staging file)</li></ul></li><li><p><strong>Parallel Downloads</strong>: Download large files using multiple workers</p><ul><li>Up to 9x faster model load times</li><li>Best for single-threaded reads of large files</li></ul></li><li><p><strong>File Cache</strong>: Cache file contents locally (Local SSD, Persistent Disk, or tmpfs)</p><ul><li>Up to 2.3x faster training time (AI/ML workloads)</li><li>Up to 3.4x higher throughput</li><li>Requires explicit cache directory configuration</li></ul></li><li><p><strong>Metadata Cache</strong>: Cache stat, type, and list operations</p><ul><li>Stat and type caches enabled by default</li><li>Configurable TTL (default: 60s, set <code>-1</code> for unlimited)</li></ul></li></ol><h2 id=caching-configuration>Caching Configuration</h2><p>gcsfuse provides four types of caching:</p><h3 id=1-stat-cache>1. Stat Cache</h3><p>Caches file attributes (size, modification time, existence).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable with unlimited size and TTL</span>
</span></span><span style=display:flex><span>gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --stat-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --metadata-cache-ttl-secs<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  bucket-name /mount/point
</span></span></code></pre></div><p><strong>Use case</strong>: Reduces API calls for repeated <code>stat()</code> operations (e.g., checking file existence).</p><h3 id=2-type-cache>2. Type Cache</h3><p>Caches file vs directory type information.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --type-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --metadata-cache-ttl-secs<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  bucket-name /mount/point
</span></span></code></pre></div><p><strong>Use case</strong>: Speeds up directory traversal and <code>ls</code> operations.</p><h3 id=3-list-cache>3. List Cache</h3><p>Caches directory listing results.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --max-conns-per-host<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --metadata-cache-ttl-secs<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  bucket-name /mount/point
</span></span></code></pre></div><p><strong>Use case</strong>: Improves performance for applications that repeatedly list directory contents.</p><h3 id=4-file-cache>4. File Cache</h3><p>Caches actual file contents locally.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cache-dir<span style=color:#ce5c00;font-weight:700>=</span>/mnt/local-ssd <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-cache-file-for-range-read<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-enable-parallel-downloads<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  bucket-name /mount/point
</span></span></code></pre></div><p><strong>Use case</strong>: Essential for AI/ML training, repeated reads of large files.</p><p><strong>Recommended cache storage</strong>:</p><ul><li><strong>Local SSD</strong>: Fastest, but ephemeral (data lost on restart)</li><li><strong>Persistent Disk</strong>: Persistent but slower than Local SSD</li><li><strong>tmpfs</strong> (RAM disk): Fastest but limited by memory</li></ul><h3 id=production-configuration-example>Production Configuration Example</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># config.yaml for gcsfuse</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata-cache</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ttl-secs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Never expire (use only if bucket is read-only or single-writer)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>stat-cache-max-size-mb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type-cache-max-size-mb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>file-cache</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>max-size-mb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Unlimited (limited by disk space)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cache-file-for-range-read</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable-parallel-downloads</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parallel-downloads-per-file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>download-chunk-size-mb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>write</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>create-empty-file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Streaming writes (default)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>severity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>info</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcsfuse --config-file<span style=color:#ce5c00;font-weight:700>=</span>config.yaml boot-assets /mnt/boot-assets
</span></span></code></pre></div><h2 id=limitations-and-considerations>Limitations and Considerations</h2><h3 id=filesystem-semantics>Filesystem Semantics</h3><p>gcsfuse provides <strong>approximate POSIX semantics</strong> but is not fully POSIX-compliant:</p><ul><li><strong>No atomic rename</strong>: Rename operations are copy-then-delete (not atomic)</li><li><strong>No hard links</strong>: GCS doesn&rsquo;t support hard links</li><li><strong>No file locking</strong>: <code>flock()</code> is a no-op</li><li><strong>Limited permissions</strong>: GCS has simpler ACLs than POSIX permissions</li><li><strong>No sparse files</strong>: Writes always materialize full file content</li></ul><h3 id=performance-anti-patterns>Performance Anti-Patterns</h3><p>❌ <strong>Avoid</strong>:</p><ul><li>Serving web content or acting as NAS (concurrent connections)</li><li>Random I/O on many small files (image datasets, text corpora)</li><li>Reading during ML training loops (download first, then train)</li><li>High-concurrency workloads (multiple parallel readers/writers)</li></ul><p>✅ <strong>Good for</strong>:</p><ul><li>Sequential reads of large files (models, checkpoints, kernels)</li><li>Infrequent writes of entire files</li><li>Read-mostly workloads with caching enabled</li><li>Single-writer scenarios</li></ul><h3 id=consistency-trade-offs>Consistency Trade-offs</h3><p><strong>With caching enabled</strong>:</p><ul><li>Stale reads possible if cache TTL > 0 and external modifications occur</li><li>Safe only for:<ul><li>Read-only buckets</li><li>Single-writer, single-mount scenarios</li><li>Workloads tolerant of eventual consistency</li></ul></li></ul><p><strong>Without caching</strong>:</p><ul><li>Strong consistency (every read fetches latest from GCS)</li><li>Much slower performance</li></ul><h3 id=resource-requirements>Resource Requirements</h3><ul><li><strong>Disk space</strong>: File cache and streaming writes require local storage<ul><li>File cache: Size of cached files (can be large for ML datasets)</li><li>Streaming writes: Temporary staging (proportional to concurrent writes)</li></ul></li><li><strong>Memory</strong>: Metadata caches consume RAM</li><li><strong>File handles</strong>: Can exceed system limits with high concurrency</li><li><strong>Network bandwidth</strong>: All data transfers via GCS API</li></ul><h2 id=installation>Installation</h2><h3 id=on-compute-engine-container-optimized-os>On Compute Engine (Container-Optimized OS)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Install gcsfuse (Container-Optimized OS doesn&#39;t include package managers)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCSFUSE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>2.x.x
</span></span><span style=display:flex><span>curl -L -O https://github.com/GoogleCloudPlatform/gcsfuse/releases/download/v<span style=color:#4e9a06>${</span><span style=color:#000>GCSFUSE_VERSION</span><span style=color:#4e9a06>}</span>/gcsfuse_<span style=color:#4e9a06>${</span><span style=color:#000>GCSFUSE_VERSION</span><span style=color:#4e9a06>}</span>_amd64.deb
</span></span><span style=display:flex><span>sudo dpkg -i gcsfuse_<span style=color:#4e9a06>${</span><span style=color:#000>GCSFUSE_VERSION</span><span style=color:#4e9a06>}</span>_amd64.deb
</span></span></code></pre></div><h3 id=on-debianubuntu>On Debian/Ubuntu</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCSFUSE_REPO</span><span style=color:#ce5c00;font-weight:700>=</span>gcsfuse-<span style=color:#4e9a06>`</span>lsb_release -c -s<span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;deb https://packages.cloud.google.com/apt </span><span style=color:#000>$GCSFUSE_REPO</span><span style=color:#4e9a06> main&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /etc/apt/sources.list.d/gcsfuse.list
</span></span><span style=display:flex><span>curl https://packages.cloud.google.com/apt/doc/apt-key.gpg <span style=color:#000;font-weight:700>|</span> sudo apt-key add -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install gcsfuse
</span></span></code></pre></div><h3 id=in-dockercloud-run>In Docker/Cloud Run</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>ubuntu:22.04</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install gcsfuse</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get install -y <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    curl <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    gnupg <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    lsb-release <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>export</span> <span style=color:#000>GCSFUSE_REPO</span><span style=color:#ce5c00;font-weight:700>=</span>gcsfuse-<span style=color:#204a87;font-weight:700>$(</span>lsb_release -c -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;deb https://packages.cloud.google.com/apt </span><span style=color:#000>$GCSFUSE_REPO</span><span style=color:#4e9a06> main&#34;</span> <span style=color:#000;font-weight:700>|</span> tee /etc/apt/sources.list.d/gcsfuse.list <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> curl https://packages.cloud.google.com/apt/doc/apt-key.gpg <span style=color:#000;font-weight:700>|</span> apt-key add - <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get update <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get install -y gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Create mount point</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkdir -p /mnt/boot-assets<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Mount gcsfuse at startup</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> gcsfuse --foreground boot-assets /mnt/boot-assets <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    /usr/local/bin/boot-server<span style=color:#a40000>
</span></span></span></code></pre></div><p><strong>Note</strong>: Cloud Run <strong>does not support FUSE filesystems</strong> (requires privileged mode). gcsfuse only works on Compute Engine or GKE.</p><h2 id=network-boot-infrastructure-evaluation>Network Boot Infrastructure Evaluation</h2><h3 id=applicability-to-adr-0005>Applicability to ADR-0005</h3><p>Based on the analysis, gcsfuse is <strong>not recommended</strong> for the network boot infrastructure for the following reasons:</p><h4 id=-cloud-run-incompatibility>❌ Cloud Run Incompatibility</h4><ul><li>gcsfuse requires FUSE kernel module and privileged containers</li><li>Cloud Run does not support FUSE or privileged mode</li><li>ADR-0005 prefers Cloud Run deployment (HTTP-only boot enables serverless)</li><li><strong>Impact</strong>: Blocks Cloud Run deployment, forcing Compute Engine VM</li></ul><h4 id=-boot-latency-requirements>❌ Boot Latency Requirements</h4><ul><li>Boot file requests target &lt; 100ms latency (ADR-0005 confirmation criteria)</li><li>gcsfuse adds 10-50ms+ latency per operation (network round-trips)</li><li>Kernel/initrd downloads are latency-sensitive (network boot timeout)</li><li><strong>Impact</strong>: May exceed boot timeout thresholds</li></ul><h4 id=-no-caching-for-read-write-workloads>❌ No Caching for Read-Write Workloads</h4><ul><li>Boot server needs to write new assets and read existing ones</li><li>File cache with unlimited TTL requires read-only or single-writer assumption</li><li>Multiple boot server instances (autoscaling) violate single-writer constraint</li><li><strong>Impact</strong>: Either accept stale reads or disable caching (slow)</li></ul><h4 id=-small-file-performance>❌ Small File Performance</h4><ul><li>Machine mapping configs, boot scripts, profiles are small files (KB range)</li><li>gcsfuse performs poorly on small, random I/O</li><li><code>ls</code> operations on directories with many profiles can be slow</li><li><strong>Impact</strong>: Slow boot configuration lookups</li></ul><h4 id=-alternative-direct-cloud-storage-sdk>✅ Alternative: Direct Cloud Storage SDK</h4><p>Using <code>cloud.google.com/go/storage</code> SDK directly offers:</p><ul><li><strong>Lower latency</strong>: Direct API calls without FUSE overhead</li><li><strong>Cloud Run compatible</strong>: No kernel module or privileged mode required</li><li><strong>Better control</strong>: Explicit caching, parallel downloads, streaming</li><li><strong>Simpler deployment</strong>: No mount management, no FUSE dependencies</li><li><strong>Cost</strong>: Similar API call costs to gcsfuse</li></ul><p><strong>Recommended approach</strong> (from ADR-0005):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Custom boot server using Cloud Storage SDK</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>storage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>:=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewClient</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>bucket</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>:=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Bucket</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;boot-assets&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Stream kernel to boot client</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>obj</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>:=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bucket</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kernels/talos-v1.6.0.img&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>reader</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>:=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewReader</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>defer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reader</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Copy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reader</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>// Stream to HTTP response</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=when-gcsfuse-might-be-useful>When gcsfuse MIGHT Be Useful</h3><p>Despite the above limitations, gcsfuse could be considered for:</p><ol><li><p><strong>Matchbox on Compute Engine</strong>:</p><ul><li>Matchbox expects filesystem paths for assets (<code>/var/lib/matchbox/assets/</code>)</li><li>Compute Engine VM supports FUSE</li><li>Read-heavy workload (boot assets rarely change)</li><li>Could mount <code>gs://boot-assets/</code> to <code>/var/lib/matchbox/assets/</code> with file cache</li></ul></li><li><p><strong>Development/Testing</strong>:</p><ul><li>Quick prototyping without writing Cloud Storage integration</li><li>Local development with production bucket access</li><li>Not recommended for production deployment</li></ul></li><li><p><strong>Low-Throughput Scenarios</strong>:</p><ul><li>Home lab scale (&lt; 10 boots/hour)</li><li>File cache enabled with Local SSD</li><li>Single Compute Engine VM (not autoscaled)</li></ul></li></ol><p><strong>Configuration for Matchbox + gcsfuse</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># Mount boot assets for Matchbox</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>BUCKET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;boot-assets&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>MOUNT_POINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/var/lib/matchbox/assets&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CACHE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/mnt/disks/local-ssd/gcsfuse-cache&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#000>$MOUNT_POINT</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$CACHE_DIR</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcsfuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --stat-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --type-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --metadata-cache-ttl-secs<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-max-size-mb<span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cache-dir<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$CACHE_DIR</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-cache-file-for-range-read<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --file-cache-enable-parallel-downloads<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --implicit-dirs <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --foreground <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#4e9a06>&#34;</span><span style=color:#000>$BUCKET</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$MOUNT_POINT</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><h2 id=monitoring-and-troubleshooting>Monitoring and Troubleshooting</h2><h3 id=metrics>Metrics</h3><p>gcsfuse exposes Prometheus metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcsfuse --prometheus --prometheus-port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9101</span> bucket /mnt/point
</span></span></code></pre></div><p><strong>Key metrics</strong>:</p><ul><li><code>gcs_read_count</code>: Number of GCS read operations</li><li><code>gcs_write_count</code>: Number of GCS write operations</li><li><code>gcs_read_bytes</code>: Bytes read from GCS</li><li><code>gcs_write_bytes</code>: Bytes written to GCS</li><li><code>fs_ops_count</code>: Filesystem operations by type (open, read, write, etc.)</li><li><code>fs_ops_error_count</code>: Filesystem operation errors</li></ul><h3 id=logging>Logging</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># JSON logging for Cloud Logging integration</span>
</span></span><span style=display:flex><span>gcsfuse --log-format<span style=color:#ce5c00;font-weight:700>=</span>json --log-file<span style=color:#ce5c00;font-weight:700>=</span>/var/log/gcsfuse.log bucket /mnt/point
</span></span></code></pre></div><h3 id=common-issues>Common Issues</h3><p><strong>Issue</strong>: <code>ls</code> on large directories takes minutes</p><p><strong>Solution</strong>:</p><ul><li>Enable list caching with <code>--metadata-cache-ttl-secs=-1</code></li><li>Reduce directory depth (flatten object hierarchy)</li><li>Consider prefix-based filtering instead of full listings</li></ul><p><strong>Issue</strong>: Stale reads after external bucket modifications</p><p><strong>Solution</strong>:</p><ul><li>Reduce <code>--metadata-cache-ttl-secs</code> (default 60s)</li><li>Disable caching entirely for strong consistency</li><li>Use versioned object names (immutable assets)</li></ul><p><strong>Issue</strong>: <code>Transport endpoint is not connected</code> errors</p><p><strong>Solution</strong>:</p><ul><li>Unmount cleanly before remounting: <code>fusermount -u /mnt/point</code></li><li>Check GCS bucket permissions (IAM roles)</li><li>Verify network connectivity to <code>storage.googleapis.com</code></li></ul><p><strong>Issue</strong>: High memory usage</p><p><strong>Solution</strong>:</p><ul><li>Limit metadata cache sizes: <code>--stat-cache-max-size-mb=1024</code></li><li>Disable file cache if not needed</li><li>Monitor with <code>--prometheus</code> metrics</li></ul><h2 id=comparison-to-alternatives>Comparison to Alternatives</h2><h3 id=gcsfuse-vs-direct-cloud-storage-sdk>gcsfuse vs Direct Cloud Storage SDK</h3><table><thead><tr><th>Aspect</th><th>gcsfuse</th><th>Cloud Storage SDK</th></tr></thead><tbody><tr><td><strong>Latency</strong></td><td>Higher (FUSE overhead + GCS API)</td><td>Lower (direct GCS API)</td></tr><tr><td><strong>Cloud Run</strong></td><td>❌ Not supported</td><td>✅ Fully supported</td></tr><tr><td><strong>Development Effort</strong></td><td>Low (standard filesystem code)</td><td>Medium (SDK integration)</td></tr><tr><td><strong>Performance</strong></td><td>Slower (filesystem abstraction)</td><td>Faster (optimized for use case)</td></tr><tr><td><strong>Caching</strong></td><td>Built-in (stat, type, list, file)</td><td>Manual (application-level)</td></tr><tr><td><strong>Streaming</strong></td><td>Automatic</td><td>Explicit (<code>io.Copy</code>)</td></tr><tr><td><strong>Dependencies</strong></td><td>FUSE kernel module, privileged mode</td><td>None (pure Go library)</td></tr></tbody></table><p><strong>Recommendation</strong>: Use Cloud Storage SDK directly for production network boot infrastructure.</p><h3 id=gcsfuse-vs-rsyncgsutil-sync>gcsfuse vs rsync/gsutil Sync</h3><p><strong>Periodic sync pattern</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Sync bucket to local disk every 5 minutes</span>
</span></span><span style=display:flex><span>*/5 * * * * gsutil -m rsync -r gs://boot-assets /var/lib/boot-assets
</span></span></code></pre></div><table><thead><tr><th>Aspect</th><th>gcsfuse</th><th>rsync/gsutil sync</th></tr></thead><tbody><tr><td><strong>Consistency</strong></td><td>Eventual (with caching)</td><td>Strong (within sync interval)</td></tr><tr><td><strong>Disk Usage</strong></td><td>Minimal (file cache optional)</td><td>Full copy of assets</td></tr><tr><td><strong>Latency</strong></td><td>GCS API per request</td><td>Local disk (fast)</td></tr><tr><td><strong>Sync Lag</strong></td><td>Real-time (no caching) or TTL</td><td>Sync interval (minutes)</td></tr><tr><td><strong>Deployment</strong></td><td>Requires FUSE</td><td>Simple cron job</td></tr></tbody></table><p><strong>Recommendation</strong>: For read-heavy, infrequent-write workloads on Compute Engine, rsync/gsutil sync is simpler and faster than gcsfuse.</p><h2 id=conclusion>Conclusion</h2><p>Cloud Storage FUSE (gcsfuse) provides a convenient filesystem abstraction over GCS buckets, but <strong>is not recommended for the network boot infrastructure</strong> due to:</p><ol><li>Cloud Run incompatibility (requires FUSE kernel module)</li><li>Added latency (FUSE overhead + network round-trips)</li><li>Poor performance for small files and concurrent access</li><li>Caching trade-offs (consistency vs performance)</li></ol><p><strong>Recommended alternatives</strong>:</p><ul><li><strong>Custom Boot Server</strong>: Direct Cloud Storage SDK integration (<code>cloud.google.com/go/storage</code>)</li><li><strong>Matchbox on Compute Engine</strong>: rsync/gsutil sync to local disk</li><li><strong>Cloud Run Deployment</strong>: Direct SDK (no gcsfuse possible)</li></ul><p>gcsfuse may be useful for <strong>development/testing</strong> or <strong>Matchbox prototyping</strong> on Compute Engine, but production deployments should use direct SDK integration or periodic sync for optimal performance and Cloud Run compatibility.</p><h2 id=references>References</h2><ul><li><a href=https://cloud.google.com/storage/docs/cloud-storage-fuse/overview>Cloud Storage FUSE Documentation</a></li><li><a href=https://github.com/GoogleCloudPlatform/gcsfuse>gcsfuse GitHub Repository</a></li><li><a href=https://cloud.google.com/storage/docs/gcsfuse-performance-and-best-practices>Performance Tuning Best Practices</a></li><li><a href=https://github.com/GoogleCloudPlatform/gcsfuse/blob/master/docs/semantics.md>gcsfuse Semantics</a></li><li><a href=../../adrs/0005-network-boot-infrastructure-gcp.md>ADR-0005: Network Boot Infrastructure Implementation on Google Cloud</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-40e0d560582430a6e545597f7b73eb02>2 - GCP Network Boot Protocol Support</h1><div class=lead>Analysis of Google Cloud Platform&rsquo;s support for TFTP, HTTP, and HTTPS routing for network boot infrastructure</div><h1 id=network-boot-protocol-support-on-google-cloud-platform>Network Boot Protocol Support on Google Cloud Platform</h1><p>This document analyzes GCP&rsquo;s capabilities for hosting network boot infrastructure, specifically focusing on TFTP, HTTP, and HTTPS protocol support.</p><h2 id=tftp-trivial-file-transfer-protocol-support>TFTP (Trivial File Transfer Protocol) Support</h2><h3 id=native-support>Native Support</h3><p><strong>Status</strong>: ❌ <strong>Not natively supported by Cloud Load Balancing</strong></p><p>GCP&rsquo;s Cloud Load Balancing services (Application Load Balancer, Network Load Balancer) do <strong>not</strong> support TFTP protocol natively. TFTP operates on UDP port 69 and has unique protocol requirements that are not compatible with GCP&rsquo;s load balancing services.</p><h3 id=implementation-options>Implementation Options</h3><h4 id=option-1-direct-vm-access-recommended-for-vpn-scenario>Option 1: Direct VM Access (Recommended for VPN Scenario)</h4><p>Since ADR-0002 specifies a VPN-based architecture, TFTP can be served directly from a Compute Engine VM without load balancing:</p><ul><li><strong>Approach</strong>: Run TFTP server (e.g., <code>tftpd-hpa</code>, <code>dnsmasq</code>) on a Compute Engine VM</li><li><strong>Access</strong>: Home lab connects via VPN tunnel to the VM&rsquo;s private IP</li><li><strong>Routing</strong>: VPC firewall rules allow UDP/69 from VPN subnet</li><li><strong>Pros</strong>:<ul><li>Simple implementation</li><li>No need for load balancing (single boot server sufficient)</li><li>TFTP traffic encrypted through VPN tunnel</li><li>Direct VM-to-client communication</li></ul></li><li><strong>Cons</strong>:<ul><li>Single point of failure (no load balancing/HA)</li><li>Manual failover required if VM fails</li></ul></li></ul><h4 id=option-2-network-load-balancer-nlb-passthrough>Option 2: Network Load Balancer (NLB) Passthrough</h4><p>While NLB doesn&rsquo;t parse TFTP protocol, it can forward UDP traffic:</p><ul><li><strong>Approach</strong>: Configure Network Load Balancer for UDP/69 passthrough</li><li><strong>Limitations</strong>:<ul><li>No protocol-aware health checks for TFTP</li><li>Health checks would use TCP or HTTP on alternate port</li><li>Adds complexity without significant benefit for single boot server</li></ul></li><li><strong>Use Case</strong>: Only relevant for multi-region HA deployment (overkill for home lab)</li></ul><h3 id=tftp-security-considerations>TFTP Security Considerations</h3><ul><li><strong>Encryption</strong>: TFTP protocol itself is unencrypted, but VPN tunnel provides encryption</li><li><strong>Firewall Rules</strong>: Restrict UDP/69 to VPN subnet only (no public access)</li><li><strong>File Access Control</strong>: Configure TFTP server with restricted file access</li><li><strong>Read-Only Mode</strong>: Deploy TFTP server in read-only mode to prevent uploads</li></ul><h2 id=http-support>HTTP Support</h2><h3 id=native-support-1>Native Support</h3><p><strong>Status</strong>: ✅ <strong>Fully supported</strong></p><p>GCP provides comprehensive HTTP support through multiple services:</p><h4 id=cloud-load-balancing---application-load-balancer>Cloud Load Balancing - Application Load Balancer</h4><ul><li><strong>Protocol Support</strong>: HTTP/1.1, HTTP/2, HTTP/3 (QUIC)</li><li><strong>Port</strong>: Any port (typically 80 for HTTP)</li><li><strong>Routing</strong>: URL-based routing, host-based routing, path-based routing</li><li><strong>Health Checks</strong>: HTTP health checks with configurable paths</li><li><strong>SSL Offloading</strong>: Can terminate SSL at load balancer and use HTTP backend</li><li><strong>Backend</strong>: Compute Engine VMs, instance groups, Cloud Run, GKE</li></ul><h4 id=compute-engine-direct-access>Compute Engine Direct Access</h4><p>For VPN scenario, HTTP can be served directly from VM:</p><ul><li><strong>Approach</strong>: Run HTTP server (nginx, Apache, custom service) on Compute Engine VM</li><li><strong>Access</strong>: Home lab accesses via VPN tunnel to private IP</li><li><strong>Firewall</strong>: VPC firewall rules allow TCP/80 from VPN subnet</li><li><strong>Pros</strong>: Simpler than load balancer for single boot server</li></ul><h3 id=http-boot-flow-for-network-boot>HTTP Boot Flow for Network Boot</h3><ol><li><strong>PXE → TFTP</strong>: Initial bootloader (iPXE) loaded via TFTP</li><li><strong>iPXE → HTTP</strong>: iPXE chainloads boot files via HTTP from same server</li><li><strong>Kernel/Initrd</strong>: Large boot files served efficiently over HTTP</li></ol><h3 id=performance-considerations>Performance Considerations</h3><ul><li><strong>Connection Pooling</strong>: HTTP/1.1 keep-alive reduces connection overhead</li><li><strong>Compression</strong>: gzip compression for text-based boot configs</li><li><strong>Caching</strong>: Cloud CDN can cache boot files for faster delivery</li><li><strong>TCP Optimization</strong>: GCP&rsquo;s network optimized for low-latency TCP</li></ul><h2 id=https-support>HTTPS Support</h2><h3 id=native-support-2>Native Support</h3><p><strong>Status</strong>: ✅ <strong>Fully supported with advanced features</strong></p><p>GCP provides enterprise-grade HTTPS support:</p><h4 id=cloud-load-balancing---application-load-balancer-1>Cloud Load Balancing - Application Load Balancer</h4><ul><li><strong>Protocol Support</strong>: HTTPS/1.1, HTTP/2 over TLS, HTTP/3 with QUIC</li><li><strong>SSL/TLS Termination</strong>: Terminate SSL at load balancer</li><li><strong>Certificate Management</strong>:<ul><li>Google-managed SSL certificates (automatic renewal)</li><li>Self-managed certificates (bring your own)</li><li>Certificate Map for multiple domains</li></ul></li><li><strong>TLS Versions</strong>: TLS 1.0, 1.1, 1.2, 1.3 (configurable minimum version)</li><li><strong>Cipher Suites</strong>: Modern, compatible, or custom cipher suites</li><li><strong>mTLS Support</strong>: Mutual TLS authentication (client certificates)</li></ul><h4 id=certificate-manager>Certificate Manager</h4><ul><li><strong>Managed Certificates</strong>: Automatic provisioning and renewal via Let&rsquo;s Encrypt integration</li><li><strong>Private CA</strong>: Integration with Google Cloud Certificate Authority Service</li><li><strong>Certificate Maps</strong>: Route different domains to different backends based on SNI</li><li><strong>Certificate Monitoring</strong>: Automatic alerts before expiration</li></ul><h3 id=https-for-network-boot>HTTPS for Network Boot</h3><h4 id=use-case>Use Case</h4><p>Modern UEFI firmware and iPXE support HTTPS boot:</p><ul><li><strong>iPXE HTTPS</strong>: iPXE compiled with <code>DOWNLOAD_PROTO_HTTPS</code> can fetch over HTTPS</li><li><strong>UEFI HTTP Boot</strong>: UEFI firmware natively supports HTTP/HTTPS boot (RFC 3720 iSCSI boot)</li><li><strong>Security</strong>: Boot file integrity verified via HTTPS chain of trust</li></ul><h4 id=implementation-on-gcp>Implementation on GCP</h4><ol><li><p><strong>Certificate Provisioning</strong>:</p><ul><li>Use Google-managed certificate for public domain (if boot server has public DNS)</li><li>Use self-signed certificate for VPN-only access (add to iPXE trust store)</li><li>Use private CA for internal PKI</li></ul></li><li><p><strong>Load Balancer Configuration</strong>:</p><ul><li>HTTPS frontend (port 443)</li><li>Backend service to Compute Engine VM running boot server</li><li>SSL policy with TLS 1.2+ minimum</li></ul></li><li><p><strong>Alternative: Direct VM HTTPS</strong>:</p><ul><li>Run nginx/Apache with TLS on Compute Engine VM</li><li>Access via VPN tunnel to private IP with HTTPS</li><li>Simpler setup for VPN-only scenario</li></ul></li></ol><h3 id=mtls-support-for-enhanced-security>mTLS Support for Enhanced Security</h3><p>GCP&rsquo;s Application Load Balancer supports mutual TLS authentication:</p><ul><li><strong>Client Certificates</strong>: Require client certificates for additional authentication</li><li><strong>Certificate Validation</strong>: Validate client certificates against trusted CA</li><li><strong>Use Case</strong>: Ensure only authorized home lab servers can access boot files</li><li><strong>Integration</strong>: Combine with VPN for defense-in-depth</li></ul><h2 id=routing-and-load-balancing-capabilities>Routing and Load Balancing Capabilities</h2><h3 id=vpc-routing>VPC Routing</h3><ul><li><strong>Custom Routes</strong>: Define routes to direct traffic through VPN gateway</li><li><strong>Route Priority</strong>: Configure route priorities for failover scenarios</li><li><strong>BGP Support</strong>: Dynamic routing with Cloud Router (for advanced VPN setups)</li></ul><h3 id=firewall-rules>Firewall Rules</h3><ul><li><strong>Ingress/Egress Rules</strong>: Fine-grained control over traffic</li><li><strong>Source/Destination Filters</strong>: IP ranges, tags, service accounts</li><li><strong>Protocol Filtering</strong>: Allow specific protocols (UDP/69, TCP/80, TCP/443)</li><li><strong>VPN Subnet Restriction</strong>: Limit access to VPN-connected home lab subnet</li></ul><h3 id=cloud-armor-optional>Cloud Armor (Optional)</h3><p>For additional security if boot server has public access:</p><ul><li><strong>DDoS Protection</strong>: Layer 3/4 DDoS mitigation</li><li><strong>WAF Rules</strong>: Application-level filtering</li><li><strong>IP Allowlisting</strong>: Restrict to known public IPs</li><li><strong>Rate Limiting</strong>: Prevent abuse</li></ul><h2 id=cost-implications>Cost Implications</h2><h3 id=network-egress-costs>Network Egress Costs</h3><ul><li><strong>VPN Traffic</strong>: Egress to VPN endpoint charged at standard internet egress rates</li><li><strong>Intra-Region</strong>: Free for traffic within same region</li><li><strong>Boot File Sizes</strong>: Typical kernel + initrd = 50-200MB per boot</li><li><strong>Monthly Estimate</strong>: 10 boots/month × 150MB = 1.5GB ≈ $0.18/month (US egress)</li></ul><h3 id=load-balancing-costs>Load Balancing Costs</h3><ul><li><strong>Application Load Balancer</strong>: ~$0.025/hour + $0.008 per LCU-hour</li><li><strong>Network Load Balancer</strong>: ~$0.025/hour + data processing charges</li><li><strong>For VPN Scenario</strong>: Load balancer likely unnecessary (single VM sufficient)</li></ul><h3 id=compute-costs>Compute Costs</h3><ul><li><strong>e2-micro Instance</strong>: ~$6-7/month (suitable for boot server)</li><li><strong>f1-micro Instance</strong>: ~$4-5/month (even smaller, might suffice)</li><li><strong>Reserved/Committed Use</strong>: Discounts for long-term commitment</li></ul><h2 id=comparison-with-requirements>Comparison with Requirements</h2><table><thead><tr><th>Requirement</th><th>GCP Support</th><th>Implementation</th></tr></thead><tbody><tr><td>TFTP</td><td>⚠️ Via VM, not LB</td><td>Direct VM access via VPN</td></tr><tr><td>HTTP</td><td>✅ Full support</td><td>VM or ALB</td></tr><tr><td>HTTPS</td><td>✅ Full support</td><td>VM or ALB with Certificate Manager</td></tr><tr><td>VPN Integration</td><td>✅ Native VPN</td><td>Cloud VPN or self-managed WireGuard</td></tr><tr><td>Load Balancing</td><td>✅ ALB, NLB</td><td>Optional for HA</td></tr><tr><td>Certificate Mgmt</td><td>✅ Managed certs</td><td>Certificate Manager</td></tr><tr><td>Cost Efficiency</td><td>✅ Low-cost VMs</td><td>e2-micro sufficient</td></tr></tbody></table><h2 id=recommendations>Recommendations</h2><h3 id=for-vpn-based-architecture-per-adr-0002>For VPN-Based Architecture (per ADR-0002)</h3><ol><li><p><strong>Compute Engine VM</strong>: Deploy single e2-micro VM with:</p><ul><li>TFTP server (<code>tftpd-hpa</code> or <code>dnsmasq</code>)</li><li>HTTP server (nginx or simple Python HTTP server)</li><li>Optional HTTPS with self-signed certificate</li></ul></li><li><p><strong>VPN Tunnel</strong>: Connect home lab to GCP via:</p><ul><li>Cloud VPN (IPsec) - easier setup, higher cost</li><li>Self-managed WireGuard on Compute Engine - lower cost, more control</li></ul></li><li><p><strong>VPC Firewall</strong>: Restrict access to:</p><ul><li>UDP/69 (TFTP) from VPN subnet only</li><li>TCP/80 (HTTP) from VPN subnet only</li><li>TCP/443 (HTTPS) from VPN subnet only</li></ul></li><li><p><strong>No Load Balancer</strong>: For home lab scale, direct VM access is sufficient</p></li><li><p><strong>Health Monitoring</strong>: Use Cloud Monitoring for VM and service health</p></li></ol><h3 id=if-ha-required-future-enhancement>If HA Required (Future Enhancement)</h3><ul><li>Deploy multi-zone VMs with Network Load Balancer</li><li>Use Cloud Storage as backend for boot files with VM serving as cache</li><li>Implement failover automation with Cloud Functions</li></ul><h2 id=references>References</h2><ul><li><a href=https://cloud.google.com/load-balancing/docs>GCP Cloud Load Balancing Documentation</a></li><li><a href=https://cloud.google.com/certificate-manager/docs>GCP Certificate Manager</a></li><li><a href=https://cloud.google.com/network-connectivity/docs/vpn>GCP Cloud VPN</a></li><li><a href=https://ipxe.org/crypto>iPXE HTTPS Boot</a></li><li><a href=https://uefi.org/specs/UEFI/2.10/24_Network_Protocols.html#http-boot>UEFI HTTP Boot</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-35563ff6a8a7c7f31535b56d4156bd8b>3 - GCP WireGuard VPN Support</h1><div class=lead>Analysis of WireGuard VPN deployment options on Google Cloud Platform for secure site-to-site connectivity</div><h1 id=wireguard-vpn-support-on-google-cloud-platform>WireGuard VPN Support on Google Cloud Platform</h1><p>This document analyzes options for deploying WireGuard VPN on GCP to establish secure site-to-site connectivity between the home lab and cloud-hosted network boot infrastructure.</p><h2 id=wireguard-overview>WireGuard Overview</h2><p>WireGuard is a modern VPN protocol that provides:</p><ul><li><strong>Simplicity</strong>: Minimal codebase (~4,000 lines vs 100,000+ for IPsec)</li><li><strong>Performance</strong>: High throughput with low overhead</li><li><strong>Security</strong>: Modern cryptography (Curve25519, ChaCha20, Poly1305, BLAKE2s)</li><li><strong>Configuration</strong>: Simple key-based configuration</li><li><strong>Kernel Integration</strong>: Mainline Linux kernel support since 5.6</li></ul><h2 id=gcp-native-vpn-support>GCP Native VPN Support</h2><h3 id=cloud-vpn-ipsec>Cloud VPN (IPsec)</h3><p><strong>Status</strong>: ❌ <strong>WireGuard not natively supported</strong></p><p>GCP&rsquo;s managed Cloud VPN service supports:</p><ul><li><strong>IPsec VPN</strong>: IKEv1, IKEv2 with PSK or certificate authentication</li><li><strong>HA VPN</strong>: Highly available VPN with 99.99% SLA</li><li><strong>Classic VPN</strong>: Single-tunnel VPN (deprecated)</li></ul><p><strong>Limitation</strong>: Cloud VPN does <strong>not</strong> support WireGuard protocol natively.</p><h3 id=cost-cloud-vpn>Cost: Cloud VPN</h3><ul><li><strong>HA VPN</strong>: ~$0.05/hour per tunnel × 2 tunnels = ~$73/month</li><li><strong>Egress</strong>: Standard internet egress rates (~$0.12/GB for first 1TB)</li><li><strong>Total Estimate</strong>: ~$75-100/month for managed VPN</li></ul><h2 id=self-managed-wireguard-on-compute-engine>Self-Managed WireGuard on Compute Engine</h2><h3 id=implementation-approach>Implementation Approach</h3><p>Since GCP doesn&rsquo;t offer managed WireGuard, deploy WireGuard on a Compute Engine VM:</p><p><strong>Status</strong>: ✅ <strong>Fully supported via Compute Engine</strong></p><h4 id=architecture>Architecture</h4><pre class=mermaid>graph LR
    A[Home Lab] --&gt;|WireGuard Tunnel| B[GCP Compute Engine VM]
    B --&gt;|Private VPC Network| C[Boot Server VM]
    B --&gt;|IP Forwarding| C
    
    subgraph &#34;Home Network&#34;
        A
        D[UDM Pro]
        D -.WireGuard Client.- A
    end
    
    subgraph &#34;GCP VPC&#34;
        B[WireGuard Gateway VM]
        C[Boot Server VM]
    end</pre><h4 id=vm-configuration>VM Configuration</h4><ol><li><p><strong>WireGuard Gateway VM</strong>:</p><ul><li><strong>Instance Type</strong>: e2-micro or f1-micro ($4-7/month)</li><li><strong>OS</strong>: Ubuntu 22.04 LTS or Debian 12 (native WireGuard kernel support)</li><li><strong>IP Forwarding</strong>: Enable IP forwarding to route traffic to other VMs</li><li><strong>External IP</strong>: Static external IP for stable WireGuard endpoint</li><li><strong>Firewall</strong>: Allow UDP port 51820 (WireGuard) from home lab public IP</li></ul></li><li><p><strong>Boot Server VM</strong>:</p><ul><li><strong>Network</strong>: Same VPC as WireGuard gateway</li><li><strong>Private IP Only</strong>: No external IP (accessed via VPN)</li><li><strong>Route Traffic</strong>: Through WireGuard gateway VM</li></ul></li></ol><h4 id=installation-steps>Installation Steps</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># On GCP Compute Engine VM (Ubuntu 22.04+)</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install wireguard wireguard-tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Generate server keys</span>
</span></span><span style=display:flex><span>wg genkey <span style=color:#000;font-weight:700>|</span> tee /etc/wireguard/server_private.key <span style=color:#000;font-weight:700>|</span> wg pubkey &gt; /etc/wireguard/server_public.key
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure WireGuard interface</span>
</span></span><span style=display:flex><span>sudo nano /etc/wireguard/wg0.conf
</span></span></code></pre></div><p><strong>Example <code>/etc/wireguard/wg0.conf</code> on GCP VM</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.1/24</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>ListenPort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>51820</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PrivateKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;SERVER_PRIVATE_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>sysctl -w net.ipv4.ip_forward=1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -A FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -t nat -A POSTROUTING -o ens4 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostDown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -D FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostDown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -t nat -D POSTROUTING -o ens4 -j MASQUERADE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Home Lab (UDM Pro)</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PublicKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;CLIENT_PUBLIC_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AllowedIPs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.2/32, 192.168.1.0/24</span>
</span></span></code></pre></div><p><strong>Corresponding config on UDM Pro</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.2/24</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PrivateKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;CLIENT_PRIVATE_KEY&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PublicKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;SERVER_PUBLIC_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Endpoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;GCP_VM_EXTERNAL_IP&gt;:51820</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AllowedIPs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.0/24, 10.128.0.0/20</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PersistentKeepalive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>25</span>
</span></span></code></pre></div><h4 id=enable-and-start-wireguard>Enable and Start WireGuard</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable IP forwarding permanently</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;net.ipv4.ip_forward=1&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span>sudo sysctl -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable WireGuard interface</span>
</span></span><span style=display:flex><span>sudo systemctl <span style=color:#204a87>enable</span> wg-quick@wg0
</span></span><span style=display:flex><span>sudo systemctl start wg-quick@wg0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Verify status</span>
</span></span><span style=display:flex><span>sudo wg show
</span></span></code></pre></div><h3 id=gcp-vpc-configuration>GCP VPC Configuration</h3><h4 id=firewall-rules>Firewall Rules</h4><p>Create VPC firewall rule to allow WireGuard:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute firewall-rules create allow-wireguard <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --direction<span style=color:#ce5c00;font-weight:700>=</span>INGRESS <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --priority<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --network<span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --action<span style=color:#ce5c00;font-weight:700>=</span>ALLOW <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --rules<span style=color:#ce5c00;font-weight:700>=</span>udp:51820 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --source-ranges<span style=color:#ce5c00;font-weight:700>=</span>&lt;HOME_LAB_PUBLIC_IP&gt;/32 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --target-tags<span style=color:#ce5c00;font-weight:700>=</span>wireguard-gateway
</span></span></code></pre></div><p>Tag the WireGuard VM:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute instances add-tags wireguard-gateway-vm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --tags<span style=color:#ce5c00;font-weight:700>=</span>wireguard-gateway <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --zone<span style=color:#ce5c00;font-weight:700>=</span>us-central1-a
</span></span></code></pre></div><h4 id=static-external-ip>Static External IP</h4><p>Reserve static IP for stable WireGuard endpoint:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute addresses create wireguard-gateway-ip <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --region<span style=color:#ce5c00;font-weight:700>=</span>us-central1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute instances delete-access-config wireguard-gateway-vm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --access-config-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;external-nat&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --zone<span style=color:#ce5c00;font-weight:700>=</span>us-central1-a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute instances add-access-config wireguard-gateway-vm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --access-config-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;external-nat&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --address<span style=color:#ce5c00;font-weight:700>=</span>wireguard-gateway-ip <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --zone<span style=color:#ce5c00;font-weight:700>=</span>us-central1-a
</span></span></code></pre></div><p><strong>Cost</strong>: Static IP ~$3-4/month if VM is always running (free if attached to running VM in some regions).</p><h4 id=route-configuration>Route Configuration</h4><p>For traffic from boot server to reach home lab via WireGuard VM:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute routes create route-to-homelab <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --network<span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --priority<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --destination-range<span style=color:#ce5c00;font-weight:700>=</span>192.168.1.0/24 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --next-hop-instance<span style=color:#ce5c00;font-weight:700>=</span>wireguard-gateway-vm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --next-hop-instance-zone<span style=color:#ce5c00;font-weight:700>=</span>us-central1-a
</span></span></code></pre></div><p>This routes home lab subnet (192.168.1.0/24) through the WireGuard gateway VM.</p><h2 id=udm-pro-wireguard-integration>UDM Pro WireGuard Integration</h2><h3 id=native-support>Native Support</h3><p><strong>Status</strong>: ✅ <strong>WireGuard supported natively</strong> (UniFi OS 1.12.22+)</p><p>The UniFi Dream Machine Pro includes native WireGuard VPN support:</p><ul><li><strong>GUI Configuration</strong>: Web UI for WireGuard VPN setup</li><li><strong>Site-to-Site</strong>: Support for site-to-site VPN tunnels</li><li><strong>Performance</strong>: Hardware acceleration for encryption (if available)</li><li><strong>Routing</strong>: Automatic route injection for remote subnets</li></ul><h3 id=configuration-steps-on-udm-pro>Configuration Steps on UDM Pro</h3><ol><li><p><strong>Network Settings → VPN</strong>:</p><ul><li>Create new VPN connection</li><li>Select &ldquo;WireGuard&rdquo;</li><li>Generate key pair or import existing</li></ul></li><li><p><strong>Peer Configuration</strong>:</p><ul><li><strong>Peer Public Key</strong>: GCP WireGuard VM&rsquo;s public key</li><li><strong>Endpoint</strong>: GCP VM&rsquo;s static external IP</li><li><strong>Port</strong>: 51820</li><li><strong>Allowed IPs</strong>: GCP VPC subnet (e.g., 10.128.0.0/20)</li><li><strong>Persistent Keepalive</strong>: 25 seconds</li></ul></li><li><p><strong>Route Injection</strong>:</p><ul><li>UDM Pro automatically adds routes to GCP subnets</li><li>Home lab servers can reach GCP boot server via VPN</li></ul></li><li><p><strong>Firewall Rules</strong>:</p><ul><li>Add firewall rule to allow boot traffic (TFTP, HTTP) from LAN to VPN</li></ul></li></ol><h3 id=alternative-manual-wireguard-on-udm-pro>Alternative: Manual WireGuard on UDM Pro</h3><p>If native support is insufficient, use <code>wireguard-go</code> via <code>udm-utilities</code>:</p><ul><li><strong>Repository</strong>: <a href=https://github.com/boostchicken/udm-utilities>boostchicken/udm-utilities</a></li><li><strong>Script</strong>: <code>on_boot.d</code> script to start WireGuard</li><li><strong>Persistence</strong>: Survives firmware updates with on-boot script</li></ul><h2 id=performance-considerations>Performance Considerations</h2><h3 id=throughput>Throughput</h3><p>WireGuard on Compute Engine performance:</p><ul><li><strong>e2-micro</strong> (2 vCPU, shared core): ~100-300 Mbps</li><li><strong>e2-small</strong> (2 vCPU): ~500-800 Mbps</li><li><strong>e2-medium</strong> (2 vCPU): ~1+ Gbps</li></ul><p>For network boot (typical boot = 50-200MB), even e2-micro is sufficient:</p><ul><li><strong>Boot Time</strong>: 150MB at 100 Mbps = ~12 seconds transfer time</li><li><strong>Recommendation</strong>: e2-micro adequate for home lab scale</li></ul><h3 id=latency>Latency</h3><ul><li><strong>VPN Overhead</strong>: WireGuard adds minimal latency (~1-5ms overhead)</li><li><strong>GCP Network</strong>: Low-latency network to most regions</li><li><strong>Total Latency</strong>: Primarily dependent on home ISP and GCP region proximity</li></ul><h3 id=cpu-usage>CPU Usage</h3><ul><li><strong>Encryption</strong>: ChaCha20 is CPU-efficient</li><li><strong>Kernel Module</strong>: Minimal CPU overhead in kernel space</li><li><strong>e2-micro</strong>: Sufficient CPU for home lab VPN throughput</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=key-management>Key Management</h3><ul><li><strong>Private Keys</strong>: Store securely, never commit to version control</li><li><strong>Key Rotation</strong>: Rotate keys periodically (e.g., annually)</li><li><strong>Secret Manager</strong>: Store WireGuard private keys in GCP Secret Manager<ul><li>Retrieve at VM startup via startup script</li><li>Avoid storing in VM metadata or disk images</li></ul></li></ul><h3 id=firewall-hardening>Firewall Hardening</h3><ul><li><strong>Source IP Restriction</strong>: Limit WireGuard port to home lab public IP only</li><li><strong>Least Privilege</strong>: Boot server firewall allows only VPN subnet</li><li><strong>No Public Access</strong>: Boot server has no external IP</li></ul><h3 id=monitoring-and-alerts>Monitoring and Alerts</h3><ul><li><strong>Cloud Logging</strong>: Log WireGuard connection events</li><li><strong>Cloud Monitoring</strong>: Alert on VPN tunnel down</li><li><strong>Metrics</strong>: Monitor handshake failures, data transfer</li></ul><h3 id=ddos-protection>DDoS Protection</h3><ul><li><strong>UDP Amplification</strong>: WireGuard resistant to DDoS amplification</li><li><strong>Cloud Armor</strong>: Optional layer for additional DDoS protection (overkill for VPN)</li></ul><h2 id=high-availability-options>High Availability Options</h2><h3 id=multi-region-failover>Multi-Region Failover</h3><p>Deploy WireGuard gateways in multiple regions:</p><ul><li><strong>Primary</strong>: us-central1 WireGuard VM</li><li><strong>Secondary</strong>: us-east1 WireGuard VM</li><li><strong>Failover</strong>: UDM Pro switches endpoints if primary fails</li><li><strong>Cost</strong>: Doubles VM costs (~$8-14/month for 2 VMs)</li></ul><h3 id=health-checks>Health Checks</h3><p>Monitor WireGuard tunnel health:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># On UDM Pro (via SSH)</span>
</span></span><span style=display:flex><span>wg show wg0 latest-handshakes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># If handshake timestamp old (&gt;3 minutes), tunnel may be down</span>
</span></span></code></pre></div><p>Automate failover with script on UDM Pro or external monitoring.</p><h3 id=startup-scripts-for-auto-healing>Startup Scripts for Auto-Healing</h3><p>GCP VM startup script to ensure WireGuard starts on boot:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># /etc/startup-script.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Retrieve WireGuard private key from Secret Manager</span>
</span></span><span style=display:flex><span>gcloud secrets versions access latest --secret<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;wireguard-server-key&#34;</span> &gt; /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Start WireGuard</span>
</span></span><span style=display:flex><span>systemctl <span style=color:#204a87>enable</span> wg-quick@wg0
</span></span><span style=display:flex><span>systemctl start wg-quick@wg0
</span></span></code></pre></div><p>Attach as metadata:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute instances add-metadata wireguard-gateway-vm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --metadata-from-file startup-script<span style=color:#ce5c00;font-weight:700>=</span>/path/to/startup-script.sh <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --zone<span style=color:#ce5c00;font-weight:700>=</span>us-central1-a
</span></span></code></pre></div><h2 id=cost-analysis>Cost Analysis</h2><h3 id=self-managed-wireguard-on-compute-engine-1>Self-Managed WireGuard on Compute Engine</h3><table><thead><tr><th>Component</th><th>Cost</th></tr></thead><tbody><tr><td>e2-micro VM (730 hrs/month)</td><td>~$6.50</td></tr><tr><td>Static External IP</td><td>~$3.50</td></tr><tr><td>Egress (1GB/month boot traffic)</td><td>~$0.12</td></tr><tr><td><strong>Monthly Total</strong></td><td><strong>~$10.12</strong></td></tr><tr><td><strong>Annual Total</strong></td><td><strong>~$121</strong></td></tr></tbody></table><h3 id=cloud-vpn-ipsec---if-wireguard-not-used>Cloud VPN (IPsec - if WireGuard not used)</h3><table><thead><tr><th>Component</th><th>Cost</th></tr></thead><tbody><tr><td>HA VPN Gateway (2 tunnels)</td><td>~$73</td></tr><tr><td>Egress (1GB/month)</td><td>~$0.12</td></tr><tr><td><strong>Monthly Total</strong></td><td><strong>~$73</strong></td></tr><tr><td><strong>Annual Total</strong></td><td><strong>~$876</strong></td></tr></tbody></table><p><strong>Cost Savings</strong>: Self-managed WireGuard saves <strong>~$755/year</strong> vs Cloud VPN.</p><h2 id=comparison-with-requirements>Comparison with Requirements</h2><table><thead><tr><th>Requirement</th><th>GCP Support</th><th>Implementation</th></tr></thead><tbody><tr><td>WireGuard Protocol</td><td>✅ Via Compute Engine</td><td>Self-managed on VM</td></tr><tr><td>Site-to-Site VPN</td><td>✅ Yes</td><td>WireGuard tunnel</td></tr><tr><td>UDM Pro Integration</td><td>✅ Native support</td><td>WireGuard peer config</td></tr><tr><td>Cost Efficiency</td><td>✅ Low cost</td><td>e2-micro ~$10/month</td></tr><tr><td>Performance</td><td>✅ Sufficient</td><td>100+ Mbps on e2-micro</td></tr><tr><td>Security</td><td>✅ Modern crypto</td><td>ChaCha20, Curve25519</td></tr><tr><td>HA (optional)</td><td>⚠️ Manual setup</td><td>Multi-region VMs</td></tr></tbody></table><h2 id=recommendations>Recommendations</h2><h3 id=for-home-lab-vpn-per-adr-0002>For Home Lab VPN (per ADR-0002)</h3><ol><li><p><strong>Self-Managed WireGuard</strong>: Deploy on Compute Engine e2-micro VM</p><ul><li><strong>Cost</strong>: ~$10/month (vs ~$73/month for Cloud VPN)</li><li><strong>Performance</strong>: Sufficient for network boot traffic</li><li><strong>Simplicity</strong>: Easy to configure and maintain</li></ul></li><li><p><strong>Single Region Deployment</strong>: Unless HA required, single VM adequate</p><ul><li><strong>Region Selection</strong>: Choose region closest to home lab for lowest latency</li><li><strong>Zone</strong>: Single zone sufficient (boot server not mission-critical)</li></ul></li><li><p><strong>UDM Pro Native WireGuard</strong>: Use built-in WireGuard client</p><ul><li><strong>Configuration</strong>: Add GCP VM as WireGuard peer in UDM Pro UI</li><li><strong>Route Injection</strong>: UDM Pro automatically routes GCP subnets</li></ul></li><li><p><strong>Security Best Practices</strong>:</p><ul><li>Store WireGuard private key in Secret Manager</li><li>Restrict WireGuard port to home public IP only</li><li>Use startup script to configure VM on boot</li><li>Enable Cloud Logging for VPN events</li></ul></li><li><p><strong>Monitoring</strong>: Set up Cloud Monitoring alerts for:</p><ul><li>VM down</li><li>High CPU usage (indicates traffic spike or issue)</li><li>Firewall rule blocks (indicates misconfiguration)</li></ul></li></ol><h3 id=future-enhancements>Future Enhancements</h3><ul><li><strong>HA Setup</strong>: Deploy secondary WireGuard VM in different region</li><li><strong>Automated Failover</strong>: Script on UDM Pro to switch endpoints</li><li><strong>IPv6 Support</strong>: Enable WireGuard over IPv6 if home ISP supports</li><li><strong>Mesh VPN</strong>: Expand to mesh topology if multiple sites added</li></ul><h2 id=references>References</h2><ul><li><a href=https://www.wireguard.com/>WireGuard Official Site</a></li><li><a href=https://wiki.archlinux.org/title/WireGuard>WireGuard on Linux</a></li><li><a href=https://cloud.google.com/vpc/docs/using-routes#static-route-next-hop>GCP Compute Engine IP Forwarding</a></li><li><a href=https://help.ui.com/hc/en-us/articles/115015971688-UniFi-VPN-Server>UniFi WireGuard VPN</a></li><li><a href=https://github.com/boostchicken/udm-utilities>udm-utilities GitHub</a></li><li><a href=https://cloud.google.com/secret-manager/docs>GCP Secret Manager</a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/Zaba505/infra aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Zaba505 | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/infra/pr-preview/pr-629/js/main.min.eb40505784d893e4b5c8dbd67b59c353e735d847f4ffbfe9d6921dec08dbacba.js integrity="sha256-60BQV4TYk+S1yNvWe1nDU+c12Ef0/7/p1pId7AjbrLo=" crossorigin=anonymous></script><script defer src=/infra/pr-preview/pr-629/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/infra/pr-preview/pr-629/js/tabpane-persist.js></script></body></html>