<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/><link rel=alternate type=application/rss+xml href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/infra/pr-preview/pr-626/favicons/favicon.ico><link rel=apple-touch-icon href=/infra/pr-preview/pr-626/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-192x192.png sizes=192x192><title>Services | Zaba505's Home Lab</title><meta name=description content="Documentation for GCP Cloud Run microservices"><meta property="og:url" content="https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/"><meta property="og:site_name" content="Zaba505's Home Lab"><meta property="og:title" content="Services"><meta property="og:description" content="Documentation for GCP Cloud Run microservices"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Services"><meta itemprop=description content="Documentation for GCP Cloud Run microservices"><meta itemprop=dateModified content="2025-11-23T19:22:14+00:00"><meta itemprop=wordCount content="64"><meta name=twitter:card content="summary"><meta name=twitter:title content="Services"><meta name=twitter:description content="Documentation for GCP Cloud Run microservices"><link rel=preload href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css as=style integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><link href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css rel=stylesheet integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/infra/pr-preview/pr-626/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Zaba505's Home Lab</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/infra/pr-preview/pr-626/offline-search-index.1ec202299b4de1252f2f0caaf86c83c2.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/infra/pr-preview/pr-626/rd/services/>Return to the regular view of this page</a>.</p></div><h1 class=title>Services</h1><div class=lead>Documentation for GCP Cloud Run microservices</div><ul><li>1: <a href=#pg-4ce2427a9523f0ff078049ecbd3abed9>Boot Server</a></li><ul><li>1.1: <a href=#pg-1723182f94fdc8c29ecf546e97e0d792>UEFI HTTP Boot Endpoints</a></li><li>1.2: <a href=#pg-6d972a5c734ebe2fd233ccd7d9e61a91>HTTP REST Admin API</a></li><li>1.3: <a href=#pg-d23c4961abd9ff24e13c96b4030bde9c>Health Check Endpoints</a></li></ul></ul><div class=content><p>This section contains documentation for the Go microservices deployed to GCP Cloud Run as part of the home lab infrastructure.</p><h2 id=service-architecture>Service Architecture</h2><p>All services follow a consistent architecture pattern:</p><ul><li><strong>Framework</strong>: Built using <code>z5labs/humus</code> framework with OpenAPI-first design</li><li><strong>Runtime</strong>: Go 1.24+ deployed to GCP Cloud Run</li><li><strong>Observability</strong>: OpenTelemetry metrics, traces, and logs</li><li><strong>Health Checks</strong>: Standard <code>/health/startup</code> and <code>/health/liveness</code> endpoints</li><li><strong>Configuration</strong>: Embedded <code>config.yaml</code> with OpenAPI specifications</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4ce2427a9523f0ff078049ecbd3abed9>1 - Boot Server</h1><div class=lead>Network boot server HTTP API specification for UEFI HTTP boot infrastructure</div><p>The Boot Server is a custom Go microservice that provides network boot capabilities for bare metal servers in the home lab. It implements UEFI HTTP boot endpoints for serving boot scripts and assets, plus an HTTP REST admin API for managing boot images, machine mappings, and boot profiles.</p><h2 id=architecture-overview>Architecture Overview</h2><p>The Boot Server is deployed on GCP Cloud Run and accessed through a WireGuard VPN tunnel from bare metal servers. It integrates with:</p><ul><li><strong>Cloud Storage</strong>: Boot images (kernels, initrd files, cloud-init configs)</li><li><strong>Firestore</strong>: Machine-to-image mappings and boot profile metadata</li><li><strong>Secret Manager</strong>: Sensitive configuration data</li><li><strong>Cloud Monitoring</strong>: OpenTelemetry observability</li></ul><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=../../adrs/0005-network-boot-infrastructure-gcp/>ADR-0005: Network Boot Infrastructure Implementation on Google Cloud</a> - Architecture decision and design rationale</li><li><a href=../../adrs/0002-network-boot-architecture/>ADR-0002: Network Boot Architecture</a> - Overall network boot strategy</li></ul><h2 id=api-categories>API Categories</h2><p>The Boot Server exposes two distinct API categories:</p><ol><li><strong><a href=./uefi-boot-endpoints/>UEFI HTTP Boot Endpoints</a></strong> - Accessed by bare metal servers during boot process (via WireGuard VPN)</li><li><strong><a href=./admin-api/>HTTP REST Admin API</a></strong> - Management API for boot configuration (authenticated)</li><li><strong><a href=./health-checks/>Health Check Endpoints</a></strong> - Standard Cloud Run health endpoints</li></ol><h2 id=security-model>Security Model</h2><h3 id=vpn-based-access-control>VPN-Based Access Control</h3><p>Since HP DL360 Gen 9 servers do not support client-side TLS certificates for UEFI HTTP boot, all boot traffic is secured via WireGuard VPN:</p><ul><li><strong>Boot Endpoints</strong>: Only accessible through WireGuard tunnel (source IP validation)</li><li><strong>Admin API</strong>: Authenticated using IAM-based authentication</li><li><strong>Transport Security</strong>: WireGuard provides mutual authentication and encryption</li></ul><h3 id=authentication-methods>Authentication Methods</h3><ul><li><strong>UEFI Boot Endpoints</strong>: VPN source IP validation (bare metal servers)</li><li><strong>Admin API</strong>: GCP IAM authentication (service accounts, user accounts)</li><li><strong>Health Checks</strong>: Unauthenticated (used by Cloud Run for liveness/startup probes)</li></ul><h2 id=common-patterns>Common Patterns</h2><h3 id=error-responses>Error Responses</h3><p>All API endpoints follow a consistent error response format:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;RESOURCE_NOT_FOUND&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Machine with MAC address aa:bb:cc:dd:ee:ff not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;aa:bb:cc:dd:ee:ff&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=standard-http-status-codes>Standard HTTP Status Codes</h3><ul><li><code>200 OK</code> - Successful request</li><li><code>201 Created</code> - Resource created successfully</li><li><code>204 No Content</code> - Successful deletion</li><li><code>400 Bad Request</code> - Invalid request parameters</li><li><code>401 Unauthorized</code> - Missing or invalid authentication</li><li><code>403 Forbidden</code> - Insufficient permissions</li><li><code>404 Not Found</code> - Resource not found</li><li><code>409 Conflict</code> - Resource already exists</li><li><code>422 Unprocessable Entity</code> - Validation error</li><li><code>500 Internal Server Error</code> - Server error</li></ul><h3 id=content-types>Content Types</h3><ul><li><code>application/json</code> - JSON responses (admin API)</li><li><code>text/plain</code> - iPXE boot scripts</li><li><code>application/octet-stream</code> - Binary boot assets (kernel, initrd)</li><li><code>text/cloud-config</code> - Cloud-init configuration files</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1723182f94fdc8c29ecf546e97e0d792>1.1 - UEFI HTTP Boot Endpoints</h1><div class=lead>Boot endpoints accessed by bare metal servers during network boot</div><p>These endpoints are accessed by bare metal servers (HP DL360 Gen 9) during the UEFI HTTP boot process. All endpoints are accessed through the WireGuard VPN tunnel and use source IP validation for security.</p><h2 id=boot-script-endpoint>Boot Script Endpoint</h2><h3 id=get-bootipxe><code>GET /boot.ipxe</code></h3><p>Serves iPXE boot scripts customized for the requesting machine based on its MAC address.</p><h4 id=sequence-diagram>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Server
    participant DB as Firestore
    
    Client-&gt;&gt;Boot: GET /boot.ipxe?mac=52:54:00:12:34:56
    Boot-&gt;&gt;Boot: Validate MAC address format
    Boot-&gt;&gt;DB: Query machine by MAC
    DB--&gt;&gt;Boot: Machine config (machine_id, profile_id, kernel args)
    Boot-&gt;&gt;DB: Get profile by ID
    DB--&gt;&gt;Boot: Profile config (image_id, kernel args)
    Boot-&gt;&gt;Boot: Generate iPXE script with machine_id
    Boot--&gt;&gt;Client: 200 OK (iPXE script)</pre><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address of the requesting machine (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/boot.ipxe?mac=52:54:00:12:34:56</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><p><strong>Response Example (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>#!ipxe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Boot configuration for node-01 (52:54:00:12:34:56)
</span></span><span class=line><span class=cl># Machine ID: 018c7dbd-9265-7000-8000-123456789abc
</span></span><span class=line><span class=cl># Profile: 018c7dbd-a1b2-7000-8000-987654321def
</span></span><span class=line><span class=cl># Generated: 2025-11-19T06:00:00Z
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kernel /assets/018c7dbd-9265-7000-8000-123456789abc/kernel console=tty0 console=ttyS0 ip=dhcp
</span></span><span class=line><span class=cl>initrd /assets/018c7dbd-9265-7000-8000-123456789abc/initrd
</span></span><span class=line><span class=cl>boot
</span></span></code></pre></div><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: text/plain; charset=utf-8</code></li><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>400 Bad Request</td><td>Missing or invalid MAC address</td><td><code>{"error": {"code": "INVALID_MAC_ADDRESS", "message": "MAC address must be in format aa:bb:cc:dd:ee:ff"}}</code></td></tr><tr><td>404 Not Found</td><td>No boot configuration found for MAC</td><td><code>{"error": {"code": "MACHINE_NOT_CONFIGURED", "message": "No boot configuration found for MAC 52:54:00:12:34:56"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Database or template error</td><td><code>{"error": {"code": "INTERNAL_ERROR", "message": "Failed to generate boot script"}}</code></td></tr></tbody></table><p><strong>Boot Script Variables:</strong></p><p>The iPXE script may include the following dynamic values:</p><ul><li>Machine-specific kernel parameters</li><li>Asset download URLs (using URN format)</li><li>Network configuration parameters</li></ul><hr><h2 id=kernel-image-endpoint>Kernel Image Endpoint</h2><h3 id=get-assetsidkernel><code>GET /assets/{id}/kernel</code></h3><p>Streams kernel images from Cloud Storage for the boot process.</p><h4 id=sequence-diagram-1>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Server
    participant DB as Firestore
    participant Storage as Cloud Storage
    
    Client-&gt;&gt;Boot: GET /assets/018c7dbd-9265-7000-8000-123456789abc/kernel
    Boot-&gt;&gt;Boot: Validate UUIDv7 format
    Boot-&gt;&gt;DB: Query machine to get image_id
    DB--&gt;&gt;Boot: Machine config (image_id)
    Boot-&gt;&gt;Storage: Stream kernel file for image
    Storage--&gt;&gt;Boot: Kernel data stream
    Boot--&gt;&gt;Client: 200 OK (kernel stream)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string (UUIDv7)</td><td>Yes</td><td>Machine identifier assigned by the boot service (UUIDv7 format: <code>018c7dbd-9265-7000-8000-123456789abc</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/assets/018c7dbd-9265-7000-8000-123456789abc/kernel</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><p><strong>Response Example (200 OK):</strong></p><p>Binary kernel image streamed from Cloud Storage.</p><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: application/octet-stream</code></li><li><code>Content-Length: 8388608</code> (actual kernel size in bytes)</li><li><code>Cache-Control: public, max-age=3600</code></li><li><code>ETag: "abc123..."</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Kernel image not found</td><td><code>{"error": {"code": "KERNEL_NOT_FOUND", "message": "Kernel image 'ubuntu-2204' not found"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Cloud Storage error</td><td><code>{"error": {"code": "STORAGE_ERROR", "message": "Failed to retrieve kernel from storage"}}</code></td></tr></tbody></table><p><strong>Performance Characteristics:</strong></p><ul><li><strong>Streaming</strong>: File is streamed directly from Cloud Storage (no buffering in memory)</li><li><strong>Target Latency</strong>: &lt; 100ms to first byte</li><li><strong>Typical Size</strong>: 8-15 MB for Linux kernels</li></ul><hr><h2 id=initrd-image-endpoint>Initrd Image Endpoint</h2><h3 id=get-assetsidinitrd><code>GET /assets/{id}/initrd</code></h3><p>Streams initial ramdisk (initrd) images from Cloud Storage for the boot process.</p><h4 id=sequence-diagram-2>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Server
    participant DB as Firestore
    participant Storage as Cloud Storage
    
    Client-&gt;&gt;Boot: GET /assets/018c7dbd-9265-7000-8000-123456789abc/initrd
    Boot-&gt;&gt;Boot: Validate UUIDv7 format
    Boot-&gt;&gt;DB: Query machine to get image_id
    DB--&gt;&gt;Boot: Machine config (image_id)
    Boot-&gt;&gt;Storage: Stream initrd file for image
    Storage--&gt;&gt;Boot: Initrd data stream
    Boot--&gt;&gt;Client: 200 OK (initrd stream)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string (UUIDv7)</td><td>Yes</td><td>Machine identifier assigned by the boot service (UUIDv7 format: <code>018c7dbd-9265-7000-8000-123456789abc</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/assets/018c7dbd-9265-7000-8000-123456789abc/initrd</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><p><strong>Response Example (200 OK):</strong></p><p>Binary initrd image streamed from Cloud Storage.</p><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: application/octet-stream</code></li><li><code>Content-Length: 52428800</code> (actual initrd size in bytes)</li><li><code>Cache-Control: public, max-age=3600</code></li><li><code>ETag: "def456..."</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Initrd image not found</td><td><code>{"error": {"code": "INITRD_NOT_FOUND", "message": "Initrd image 'ubuntu-2204' not found"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Cloud Storage error</td><td><code>{"error": {"code": "STORAGE_ERROR", "message": "Failed to retrieve initrd from storage"}}</code></td></tr></tbody></table><p><strong>Performance Characteristics:</strong></p><ul><li><strong>Streaming</strong>: File is streamed directly from Cloud Storage (no buffering in memory)</li><li><strong>Target Latency</strong>: &lt; 100ms to first byte</li><li><strong>Typical Size</strong>: 50-150 MB for Linux initrd images</li></ul><hr><h2 id=security-considerations>Security Considerations</h2><h3 id=vpn-source-ip-validation>VPN Source IP Validation</h3><p>All boot endpoints validate that requests originate from the WireGuard VPN subnet:</p><ul><li><strong>Allowed CIDR</strong>: <code>10.x.x.0/24</code> (WireGuard VPN network)</li><li><strong>Validation</strong>: Performed at Cloud Run ingress or application layer</li><li><strong>Rejection</strong>: Requests from outside VPN return <code>403 Forbidden</code></li></ul><h3 id=rate-limiting>Rate Limiting</h3><p>To prevent abuse, boot endpoints are rate-limited:</p><ul><li><strong>Boot Script</strong>: 10 requests/minute per MAC address</li><li><strong>Asset Downloads</strong>: 5 concurrent downloads per MAC address</li></ul><h3 id=asset-integrity>Asset Integrity</h3><p>Boot assets are validated for integrity:</p><ul><li><strong>Checksums</strong>: SHA-256 checksums stored in Firestore</li><li><strong>Verification</strong>: Computed on upload, verified on download (optional)</li><li><strong>ETag Headers</strong>: Enable client-side caching and integrity checks</li></ul><h2 id=observability>Observability</h2><p>All boot endpoint requests are instrumented with OpenTelemetry following HTTP semantic conventions:</p><ul><li><strong>Metrics</strong>: OpenTelemetry HTTP server metrics (request count, duration, size)<ul><li><code>http.server.request.duration</code> - Request duration histogram</li><li><code>http.server.request.body.size</code> - Request body size</li><li><code>http.server.response.body.size</code> - Response body size (tracks bytes transferred)</li></ul></li><li><strong>Traces</strong>: End-to-end tracing from request to Cloud Storage retrieval<ul><li>HTTP server span captures request details (method, route, status code)</li><li>Child spans for database queries and Cloud Storage operations</li></ul></li><li><strong>Logs</strong>: Structured logs with MAC address, image ID, response status</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6d972a5c734ebe2fd233ccd7d9e61a91>1.2 - HTTP REST Admin API</h1><div class=lead>Management API for boot images, machines, and profiles</div><p>The Admin API provides HTTP REST endpoints for managing boot images, machine mappings, and boot profiles. Since this is for a home lab environment, no authentication is required.</p><h2 id=boot-image-management>Boot Image Management</h2><h3 id=post-apiv1images><code>POST /api/v1/images</code></h3><p>Upload a new boot image (kernel, initrd, and metadata).</p><h4 id=sequence-diagram>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant Storage as Cloud Storage
    participant DB as Firestore
    
    Client-&gt;&gt;API: POST /api/v1/images (multipart/form-data)
    API-&gt;&gt;API: Validate URN format
    API-&gt;&gt;API: Compute SHA-256 checksums
    API-&gt;&gt;Storage: Upload kernel file
    Storage--&gt;&gt;API: Upload complete
    API-&gt;&gt;Storage: Upload initrd file
    Storage--&gt;&gt;API: Upload complete
    API-&gt;&gt;DB: Store metadata (URN, checksums, sizes)
    DB--&gt;&gt;API: Metadata stored
    API--&gt;&gt;Client: 201 Created (image metadata)</pre><p><strong>Request Body (multipart/form-data):</strong></p><p>Form fields:</p><ul><li><code>id</code> (text): Boot image identifier (UUIDv7 format)</li><li><code>name</code> (text): Human-readable name</li><li><code>version</code> (text): Semantic version</li><li><code>kernel</code> (file): Kernel image file</li><li><code>initrd</code> (file): Initrd image file</li><li><code>metadata</code> (JSON text): Metadata object</li></ul><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api/v1/images</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;id&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>018c7dbd-9265-7000-8000-123456789abc
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;name&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ubuntu 22.04 LTS Server
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;version&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>22.04.3
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;kernel&#34;; filename=&#34;vmlinuz&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;kernel binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;initrd&#34;; filename=&#34;initrd.img&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;initrd binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;metadata&#34;
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;os&#34;:&#34;ubuntu&#34;,&#34;os_version&#34;:&#34;22.04.3&#34;,&#34;architecture&#34;:&#34;x86_64&#34;,&#34;tags&#34;:[&#34;lts&#34;,&#34;server&#34;]}
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW--
</span></span></code></pre></div><p><strong>Request Headers:</strong></p><ul><li><code>Content-Type: multipart/form-data</code></li></ul><p><strong>Response (201 Created):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;urn:boot:image:ubuntu-2204&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu 22.04 LTS Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;a1b2c3d4e5f6789...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>8388608</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;f6e5d4c3b2a19876...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>52428800</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;ubuntu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;os_version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;lts&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>400 Bad Request</td><td>Invalid request body or missing required fields</td></tr><tr><td>409 Conflict</td><td>Image with the same ID already exists</td></tr><tr><td>422 Unprocessable Entity</td><td>Validation error (invalid URN format, file too large)</td></tr></tbody></table><hr><h3 id=get-apiv1images><code>GET /api/v1/images</code></h3><p>List all boot images.</p><h4 id=sequence-diagram-1>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/images?os=ubuntu
    API-&gt;&gt;DB: Query images with filters
    DB--&gt;&gt;API: Image metadata list
    API--&gt;&gt;Client: 200 OK (images list)</pre><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>page</code></td><td>integer</td><td>No</td><td>Page number (1-indexed)</td><td>1</td></tr><tr><td><code>per_page</code></td><td>integer</td><td>No</td><td>Results per page (1-100)</td><td>20</td></tr><tr><td><code>os</code></td><td>string</td><td>No</td><td>Filter by operating system</td><td>-</td></tr><tr><td><code>architecture</code></td><td>string</td><td>No</td><td>Filter by architecture</td><td>-</td></tr><tr><td><code>tags</code></td><td>string</td><td>No</td><td>Filter by tags (comma-separated)</td><td>-</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/images?os=ubuntu&amp;architecture=x86_64&amp;page=1&amp;per_page=20</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;images&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-9265-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu 22.04 LTS Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;a1b2c3d4e5f6789...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>8388608</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;f6e5d4c3b2a19876...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>52428800</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;ubuntu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;os_version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;lts&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pagination&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total_pages&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h3 id=get-apiv1imagesid><code>GET /api/v1/images/{id}</code></h3><p>Retrieve a specific boot image by ID.</p><h4 id=sequence-diagram-2>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/images/{id}
    API-&gt;&gt;DB: Query image by ID
    DB--&gt;&gt;API: Image metadata
    API--&gt;&gt;Client: 200 OK (image metadata)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Boot image identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/images/018c7dbd-9265-7000-8000-123456789abc</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-9265-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu 22.04 LTS Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;a1b2c3d4e5f6789...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>8388608</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sha256&#34;</span><span class=p>:</span> <span class=s2>&#34;f6e5d4c3b2a19876...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size_bytes&#34;</span><span class=p>:</span> <span class=mi>52428800</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;os&#34;</span><span class=p>:</span> <span class=s2>&#34;ubuntu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;os_version&#34;</span><span class=p>:</span> <span class=s2>&#34;22.04.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;lts&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Image with specified ID not found</td></tr></tbody></table><hr><h3 id=delete-apiv1imagesid><code>DELETE /api/v1/images/{id}</code></h3><p>Delete a boot image.</p><h4 id=sequence-diagram-3>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant Storage as Cloud Storage
    participant DB as Firestore
    
    Client-&gt;&gt;API: DELETE /api/v1/images/{id}
    API-&gt;&gt;DB: Check if image is in use
    DB--&gt;&gt;API: Not in use
    API-&gt;&gt;Storage: Delete kernel file
    API-&gt;&gt;Storage: Delete initrd file
    API-&gt;&gt;DB: Delete metadata
    API--&gt;&gt;Client: 204 No Content</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Boot image identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>DELETE</span> <span class=nn>/api/v1/images/018c7dbd-9265-7000-8000-123456789abc</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><p><strong>Response (204 No Content):</strong></p><p>Empty response body.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Image with specified ID not found</td></tr><tr><td>409 Conflict</td><td>Image is currently in use by one or more machines</td></tr></tbody></table><hr><h2 id=machine-mapping-management>Machine Mapping Management</h2><h3 id=post-apiv1machines><code>POST /api/v1/machines</code></h3><p>Register a new machine and map it to a boot profile.</p><h4 id=sequence-diagram-4>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: POST /api/v1/machines
    API-&gt;&gt;API: Validate MAC address format
    API-&gt;&gt;DB: Check if profile_id exists
    DB--&gt;&gt;API: Profile found
    API-&gt;&gt;DB: Store machine mapping
    DB--&gt;&gt;API: Machine registered
    API--&gt;&gt;Client: 201 Created (machine config)</pre><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;hostname&#34;</span><span class=p>:</span> <span class=s2>&#34;node-01&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;datacenter&#34;</span><span class=p>:</span> <span class=s2>&#34;homelab&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;compute&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ip_address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;netmask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.255.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;gateway&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dns_servers&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span> <span class=s2>&#34;8.8.8.8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Response (201 Created):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;hostname&#34;</span><span class=p>:</span> <span class=s2>&#34;node-01&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;datacenter&#34;</span><span class=p>:</span> <span class=s2>&#34;homelab&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;compute&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ip_address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;netmask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.255.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;gateway&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dns_servers&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span> <span class=s2>&#34;8.8.8.8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>400 Bad Request</td><td>Invalid MAC address format or missing required fields</td></tr><tr><td>409 Conflict</td><td>Machine with the same MAC address already exists</td></tr><tr><td>422 Unprocessable Entity</td><td>Referenced profile_id does not exist</td></tr></tbody></table><hr><h3 id=get-apiv1machines><code>GET /api/v1/machines</code></h3><p>List all registered machines.</p><h4 id=sequence-diagram-5>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/machines?profile_id=...
    API-&gt;&gt;DB: Query machines with filters
    DB--&gt;&gt;API: Machine list
    API--&gt;&gt;Client: 200 OK (machines list)</pre><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>page</code></td><td>integer</td><td>No</td><td>Page number (1-indexed)</td><td>1</td></tr><tr><td><code>per_page</code></td><td>integer</td><td>No</td><td>Results per page (1-100)</td><td>20</td></tr><tr><td><code>profile_id</code></td><td>string</td><td>No</td><td>Filter by boot profile</td><td>-</td></tr><tr><td><code>role</code></td><td>string</td><td>No</td><td>Filter by machine role</td><td>-</td></tr></tbody></table><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;machines&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;hostname&#34;</span><span class=p>:</span> <span class=s2>&#34;node-01&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;datacenter&#34;</span><span class=p>:</span> <span class=s2>&#34;homelab&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;compute&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ip_address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;netmask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.255.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;gateway&#34;</span><span class=p>:</span> <span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;dns_servers&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;10.0.1.1&#34;</span><span class=p>,</span> <span class=s2>&#34;8.8.8.8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pagination&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total_pages&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h3 id=get-apiv1machinesmac><code>GET /api/v1/machines/{mac}</code></h3><p>Retrieve a specific machine configuration by MAC address.</p><h4 id=sequence-diagram-6>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/machines/{mac}
    API-&gt;&gt;DB: Query machine by MAC
    DB--&gt;&gt;API: Machine config
    API--&gt;&gt;Client: 200 OK (machine config)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Response (200 OK):</strong></p><p>Same as POST response.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified MAC address not found</td></tr></tbody></table><hr><h3 id=put-apiv1machinesmac><code>PUT /api/v1/machines/{mac}</code></h3><p>Update a machine&rsquo;s configuration.</p><h4 id=sequence-diagram-7>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: PUT /api/v1/machines/{mac}
    API-&gt;&gt;DB: Check if profile_id exists (if updated)
    DB--&gt;&gt;API: Profile found
    API-&gt;&gt;DB: Update machine config
    DB--&gt;&gt;API: Machine updated
    API--&gt;&gt;Client: 200 OK (updated config)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-000000000002&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;datacenter&#34;</span><span class=p>:</span> <span class=s2>&#34;homelab&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rack&#34;</span><span class=p>:</span> <span class=s2>&#34;A1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;storage&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><p>Full machine configuration with updated fields.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified MAC address not found</td></tr><tr><td>422 Unprocessable Entity</td><td>Referenced profile_id does not exist</td></tr></tbody></table><hr><h3 id=delete-apiv1machinesmac><code>DELETE /api/v1/machines/{mac}</code></h3><p>Delete a machine registration.</p><h4 id=sequence-diagram-8>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: DELETE /api/v1/machines/{mac}
    API-&gt;&gt;DB: Delete machine by MAC
    DB--&gt;&gt;API: Machine deleted
    API--&gt;&gt;Client: 204 No Content</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Response (204 No Content):</strong></p><p>Empty response body.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified MAC address not found</td></tr></tbody></table><hr><h2 id=boot-profile-management>Boot Profile Management</h2><h3 id=post-apiv1profiles><code>POST /api/v1/profiles</code></h3><p>Create a new boot profile.</p><h4 id=sequence-diagram-9>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: POST /api/v1/profiles
    API-&gt;&gt;API: Validate identifier format
    API-&gt;&gt;DB: Check if image_id exists
    DB--&gt;&gt;API: Image found
    API-&gt;&gt;DB: Store profile
    DB--&gt;&gt;API: Profile created
    API--&gt;&gt;Client: 201 Created (profile config)</pre><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu Server Base Profile&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;image_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-9265-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel_args&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip=dhcp&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Base Ubuntu server configuration with minimal packages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;minimal&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Response (201 Created):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu Server Base Profile&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;image_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-9265-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel_args&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip=dhcp&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Base Ubuntu server configuration with minimal packages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;minimal&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>409 Conflict</td><td>Profile with the same ID already exists</td></tr><tr><td>422 Unprocessable Entity</td><td>Referenced image_id does not exist</td></tr></tbody></table><hr><h3 id=get-apiv1profiles><code>GET /api/v1/profiles</code></h3><p>List all boot profiles.</p><h4 id=sequence-diagram-10>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/profiles?image_id=...
    API-&gt;&gt;DB: Query profiles with filters
    DB--&gt;&gt;API: Profile list
    API--&gt;&gt;Client: 200 OK (profiles list)</pre><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>page</code></td><td>integer</td><td>No</td><td>Page number (1-indexed)</td><td>1</td></tr><tr><td><code>per_page</code></td><td>integer</td><td>No</td><td>Results per page (1-100)</td><td>20</td></tr><tr><td><code>image_id</code></td><td>string</td><td>No</td><td>Filter by boot image (UUIDv7)</td><td>-</td></tr></tbody></table><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;profiles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu Server Base Profile&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;image_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-9265-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;kernel_args&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ip=dhcp&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Base Ubuntu server configuration with minimal packages&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;minimal&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;updated_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pagination&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total_pages&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h3 id=get-apiv1profilesid><code>GET /api/v1/profiles/{id}</code></h3><p>Retrieve a specific boot profile.</p><h4 id=sequence-diagram-11>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: GET /api/v1/profiles/{id}
    API-&gt;&gt;DB: Query profile by ID
    DB--&gt;&gt;API: Profile config
    API--&gt;&gt;Client: 200 OK (profile config)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Boot profile identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Response (200 OK):</strong></p><p>Same as POST response.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Profile with specified ID not found</td></tr></tbody></table><hr><h3 id=put-apiv1profilesid><code>PUT /api/v1/profiles/{id}</code></h3><p>Update a boot profile.</p><h4 id=sequence-diagram-12>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: PUT /api/v1/profiles/{id}
    API-&gt;&gt;DB: Check if image_id exists (if updated)
    DB--&gt;&gt;API: Image found
    API-&gt;&gt;DB: Update profile
    DB--&gt;&gt;API: Profile updated
    API--&gt;&gt;Client: 200 OK (updated config)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Boot profile identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel_args&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip=dhcp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;net.ifnames=0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Updated Ubuntu server configuration&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;minimal&#34;</span><span class=p>,</span> <span class=s2>&#34;updated&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><p>Full profile configuration with updated fields.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Profile with specified ID not found</td></tr><tr><td>422 Unprocessable Entity</td><td>Referenced image_id does not exist (if updated)</td></tr></tbody></table><hr><h3 id=delete-apiv1profilesid><code>DELETE /api/v1/profiles/{id}</code></h3><p>Delete a boot profile.</p><h4 id=sequence-diagram-13>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: DELETE /api/v1/profiles/{id}
    API-&gt;&gt;DB: Check if profile is in use
    DB--&gt;&gt;API: Not in use
    API-&gt;&gt;DB: Delete profile
    DB--&gt;&gt;API: Profile deleted
    API--&gt;&gt;Client: 204 No Content</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Boot profile identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Response (204 No Content):</strong></p><p>Empty response body.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Profile with specified ID not found</td></tr><tr><td>409 Conflict</td><td>Profile is currently assigned to one or more machines</td></tr></tbody></table><hr><h2 id=machine-rollback>Machine Rollback</h2><h3 id=post-apiv1machinesmacrollback><code>POST /api/v1/machines/{mac}/rollback</code></h3><p>Rollback a machine to its previous boot profile.</p><h4 id=sequence-diagram-14>Sequence Diagram</h4><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Boot Server API
    participant DB as Firestore
    
    Client-&gt;&gt;API: POST /api/v1/machines/{mac}/rollback
    API-&gt;&gt;DB: Get machine history
    DB--&gt;&gt;API: Previous profile_id
    API-&gt;&gt;DB: Update machine to previous profile
    DB--&gt;&gt;API: Machine rolled back
    API-&gt;&gt;DB: Record rollback event
    API--&gt;&gt;Client: 200 OK (rollback details)</pre><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Failed upgrade to new kernel version&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;hostname&#34;</span><span class=p>:</span> <span class=s2>&#34;node-01&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;previous_profile_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-000000000002&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;rollback_reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Failed upgrade to new kernel version&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;rollback_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:30:00Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified MAC address not found</td></tr><tr><td>409 Conflict</td><td>No previous profile available for rollback</td></tr></tbody></table><p><strong>Rollback History:</strong></p><p>The system maintains a history of profile changes to enable rollback:</p><ul><li>Up to 10 previous profile assignments per machine</li><li>Rollback can be performed multiple times (limited by history depth)</li><li>History includes timestamp, user, and reason for each change</li></ul><hr><h2 id=data-models>Data Models</h2><h3 id=boot-image>Boot Image</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>BootImage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>string</span><span class=p>;</span>              <span class=c1>// UUIDv7 identifier (e.g., &#34;018c7dbd-9265-7000-8000-123456789abc&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>            <span class=c1>// Human-readable name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>version</span>: <span class=kt>string</span><span class=p>;</span>         <span class=c1>// Semantic version
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>kernel</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span>: <span class=kt>string</span><span class=p>;</span>           <span class=c1>// Cloud Storage URL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sha256</span>: <span class=kt>string</span><span class=p>;</span>        <span class=c1>// SHA-256 checksum
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>size_bytes</span>: <span class=kt>number</span><span class=p>;</span>    <span class=c1>// File size in bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>initrd</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span>: <span class=kt>string</span><span class=p>;</span>           <span class=c1>// Cloud Storage URL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sha256</span>: <span class=kt>string</span><span class=p>;</span>        <span class=c1>// SHA-256 checksum
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>size_bytes</span>: <span class=kt>number</span><span class=p>;</span>    <span class=c1>// File size in bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>os</span>: <span class=kt>string</span><span class=p>;</span>            <span class=c1>// Operating system (ubuntu, fedora, talos)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>os_version</span>: <span class=kt>string</span><span class=p>;</span>    <span class=c1>// OS version
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>architecture</span>: <span class=kt>string</span><span class=p>;</span>  <span class=c1>// CPU architecture (x86_64, arm64)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tags</span>: <span class=kt>string</span><span class=p>[];</span>        <span class=c1>// Custom tags
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>created_at</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// ISO 8601 timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>created_by</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// User or service account email
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h3 id=machine>Machine</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>Machine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mac_address</span>: <span class=kt>string</span><span class=p>;</span>     <span class=c1>// MAC address (primary key)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>hostname</span>: <span class=kt>string</span><span class=p>;</span>        <span class=c1>// Machine hostname
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>profile_id</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// Reference to boot profile (UUIDv7)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>datacenter?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>rack?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>role?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=kt>any</span><span class=p>;</span>    <span class=c1>// Custom metadata
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>network</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ip_address?</span>: <span class=kt>string</span><span class=p>;</span>   <span class=c1>// Static IP (optional)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>netmask?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>gateway?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>dns_servers?</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>created_at</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// ISO 8601 timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>updated_at</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// ISO 8601 timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h3 id=boot-profile>Boot Profile</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>BootProfile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>string</span><span class=p>;</span>              <span class=c1>// UUIDv7 identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>            <span class=c1>// Human-readable name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>image_id</span>: <span class=kt>string</span><span class=p>;</span>        <span class=c1>// Reference to boot image (UUIDv7)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>kernel_args</span>: <span class=kt>string</span><span class=p>[];</span>   <span class=c1>// Kernel command-line arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>cloud_init_template</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// Cloud-init template filename
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>description?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tags?</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=kt>any</span><span class=p>;</span>    <span class=c1>// Custom metadata
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>created_at</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// ISO 8601 timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>updated_at</span>: <span class=kt>string</span><span class=p>;</span>      <span class=c1>// ISO 8601 timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><hr><h2 id=rate-limiting>Rate Limiting</h2><p>Admin API endpoints are rate-limited to prevent abuse:</p><ul><li><strong>Per User/Service Account</strong>: 100 requests/minute</li><li><strong>Per IP Address</strong>: 300 requests/minute</li><li><strong>Global</strong>: 1000 requests/minute</li></ul><p>Rate limit headers are included in responses:</p><pre tabindex=0><code>X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1700000000
</code></pre><p>When rate limit is exceeded, API returns <code>429 Too Many Requests</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;RATE_LIMIT_EXCEEDED&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Rate limit exceeded. Try again in 30 seconds.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;retry_after&#34;</span><span class=p>:</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h2 id=versioning>Versioning</h2><p>The Admin API uses URL versioning (<code>/api/v1/</code>):</p><ul><li><strong>Current Version</strong>: v1</li><li><strong>Deprecation Policy</strong>: Minimum 6 months notice before version deprecation</li><li><strong>Version Header</strong>: <code>X-API-Version: v1</code> included in all responses</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d23c4961abd9ff24e13c96b4030bde9c>1.3 - Health Check Endpoints</h1><div class=lead>Standard Cloud Run health check endpoints for startup and liveness probes</div><p>The Boot Server exposes standard health check endpoints used by GCP Cloud Run for startup and liveness probes. These endpoints are unauthenticated and accessible without VPN access.</p><h2 id=startup-probe>Startup Probe</h2><h3 id=get-healthstartup><code>GET /health/startup</code></h3><p>Indicates whether the application has completed initialization and is ready to receive traffic.</p><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/health/startup</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><p>Empty response body with HTTP 200 status code.</p><p><strong>Response (503 Service Unavailable):</strong></p><p>Empty response body with HTTP 503 status code.</p><p><strong>Response Headers:</strong></p><ul><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><p><strong>Startup Check Components:</strong></p><ol><li><strong>Firestore Connection</strong> - Verifies database connectivity</li><li><strong>Cloud Storage Access</strong> - Validates access to boot image buckets</li></ol><p><strong>Cloud Run Configuration:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>startupProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health/startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li><strong>Success (200)</strong>: Application is fully initialized and ready to serve requests</li><li><strong>Failure (503)</strong>: Application is still starting up or encountered initialization errors</li><li><strong>Timeout</strong>: After 30 seconds of no response, Cloud Run considers startup failed</li></ul><hr><h2 id=liveness-probe>Liveness Probe</h2><h3 id=get-healthliveness><code>GET /health/liveness</code></h3><p>Indicates whether the application is alive and healthy. Used by Cloud Run to detect and restart unhealthy instances.</p><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/health/liveness</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><p><strong>Response (200 OK):</strong></p><p>Empty response body with HTTP 200 status code.</p><p><strong>Response (503 Service Unavailable):</strong></p><p>Empty response body with HTTP 503 status code.</p><p><strong>Response Headers:</strong></p><ul><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><p><strong>Liveness Check Components:</strong></p><ol><li><strong>HTTP Server Health</strong> - Verifies the HTTP server is responsive</li><li><strong>Basic health validation</strong> - Ensures the application can handle requests</li></ol><p><strong>Cloud Run Configuration:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health/liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li><strong>Success (200)</strong>: Application is healthy and functioning normally</li><li><strong>Failure (503)</strong>: Application is unhealthy and should be restarted</li><li><strong>Consecutive Failures</strong>: After 3 consecutive failures (30 seconds), Cloud Run restarts the instance</li></ul><hr><h2 id=health-check-strategy>Health Check Strategy</h2><h3 id=startup-vs-liveness>Startup vs Liveness</h3><table><thead><tr><th>Aspect</th><th>Startup Probe</th><th>Liveness Probe</th></tr></thead><tbody><tr><td><strong>Purpose</strong></td><td>One-time initialization check</td><td>Ongoing health monitoring</td></tr><tr><td><strong>Frequency</strong></td><td>Every 10s during startup</td><td>Every 10s after startup</td></tr><tr><td><strong>Timeout</strong></td><td>30 seconds</td><td>30 seconds</td></tr><tr><td><strong>Failure Action</strong></td><td>Prevent traffic routing</td><td>Restart container</td></tr><tr><td><strong>Checks Performed</strong></td><td>Full dependency validation</td><td>Lightweight health checks</td></tr></tbody></table><h3 id=graceful-degradation>Graceful Degradation</h3><p>The health checks are designed with graceful degradation in mind:</p><ul><li><strong>Critical Failures</strong>: Return 503 and trigger restart (e.g., database connection lost)</li><li><strong>Non-Critical Failures</strong>: Log warnings but return 200 (e.g., temporary Cloud Storage timeout)</li><li><strong>Transient Errors</strong>: Retry internally before reporting failure</li></ul><h3 id=health-check-dependencies>Health Check Dependencies</h3><pre class=mermaid>graph TD
    A[Health Check Request] --&gt; B{Check Type}
    B --&gt;|Startup| C[Full Initialization Check]
    B --&gt;|Liveness| D[Runtime Health Check]
    
    C --&gt; E[Firestore Connection]
    C --&gt; F[Cloud Storage Access]
    
    E --&gt; H{All OK?}
    F --&gt; H
    
    H --&gt;|Yes| I[200 OK]
    H --&gt;|No| J[503 Service Unavailable]
    
    D --&gt; K[Server Responsive]
    
    K --&gt; N{OK?}
    
    N --&gt;|Yes| O[200 OK]
    N --&gt;|No| P[503 Service Unavailable]</pre><hr><h2 id=observability>Observability</h2><p>Health check results are logged and monitored:</p><p><strong>Metrics:</strong></p><ul><li><code>health_check_total{probe="startup",status="ok"}</code> - Successful startup checks</li><li><code>health_check_total{probe="startup",status="error"}</code> - Failed startup checks</li><li><code>health_check_total{probe="liveness",status="ok"}</code> - Successful liveness checks</li><li><code>health_check_total{probe="liveness",status="error"}</code> - Failed liveness checks</li><li><code>health_check_duration_ms{probe="startup"}</code> - Startup check duration</li><li><code>health_check_duration_ms{probe="liveness"}</code> - Liveness check duration</li></ul><p><strong>Structured Logs:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;severity&#34;</span><span class=p>:</span> <span class=s2>&#34;INFO&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Health check completed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;probe&#34;</span><span class=p>:</span> <span class=s2>&#34;liveness&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;ok&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;duration_ms&#34;</span><span class=p>:</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Alerts:</strong></p><ul><li><strong>Startup Failure</strong>: Alert if startup check fails for > 1 minute</li><li><strong>Liveness Failure</strong>: Alert if liveness check fails 3+ times consecutively</li><li><strong>High Restart Rate</strong>: Alert if container restarts > 3 times in 5 minutes</li></ul><hr><h2 id=testing-health-checks>Testing Health Checks</h2><h3 id=manual-testing>Manual Testing</h3><p>Test startup probe:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v http://localhost:8080/health/startup
</span></span></code></pre></div><p>Test liveness probe:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v http://localhost:8080/health/liveness
</span></span></code></pre></div><h3 id=automated-testing>Automated Testing</h3><p>Health checks should be included in integration tests:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>TestHealthStartup</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/health/startup&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=load-testing>Load Testing</h3><p>Health check endpoints should handle high request rates without degrading application performance:</p><ul><li><strong>Target</strong>: 100 requests/second sustained</li><li><strong>Timeout</strong>: &lt; 10ms average response time</li><li><strong>Resource Impact</strong>: &lt; 1% CPU, &lt; 10MB memory overhead</li></ul><hr><h2 id=best-practices>Best Practices</h2><ol><li><strong>Keep Checks Fast</strong>: Health checks should complete in &lt; 100ms under normal conditions</li><li><strong>Avoid External Dependencies</strong>: Don&rsquo;t make external API calls in health checks (use connection pool status instead)</li><li><strong>Use Circuit Breakers</strong>: Implement circuit breakers for dependency checks to prevent cascading failures</li><li><strong>Log Check Failures</strong>: Always log detailed information when health checks fail</li><li><strong>Test Failure Scenarios</strong>: Regularly test health check behavior under failure conditions</li><li><strong>Monitor Check Duration</strong>: Alert on health checks taking > 1 second (indicates performance issues)</li></ol><hr><h2 id=troubleshooting>Troubleshooting</h2><h3 id=startup-check-never-succeeds>Startup Check Never Succeeds</h3><p><strong>Symptoms:</strong></p><ul><li>Container restarts repeatedly</li><li>Cloud Run shows &ldquo;unhealthy&rdquo; status</li><li>Startup probe returns 503</li></ul><p><strong>Debugging:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Check Cloud Run logs for startup errors</span>
</span></span><span class=line><span class=cl>gcloud logging <span class=nb>read</span> <span class=s2>&#34;resource.type=cloud_run_revision AND labels.service_name=boot-server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --limit <span class=m>50</span> --format json <span class=p>|</span> jq <span class=s1>&#39;.[] | select(.jsonPayload.probe==&#34;startup&#34;)&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test locally with debug logging</span>
</span></span><span class=line><span class=cl><span class=nv>DEBUG</span><span class=o>=</span><span class=nb>true</span> go run main.go
</span></span></code></pre></div><p><strong>Common Causes:</strong></p><ul><li>Firestore credentials not configured</li><li>Cloud Storage bucket permissions missing</li><li>Network connectivity issues</li><li>Timeout too short for slow dependencies</li></ul><h3 id=liveness-check-intermittent-failures>Liveness Check Intermittent Failures</h3><p><strong>Symptoms:</strong></p><ul><li>Occasional container restarts</li><li>Liveness probe returns 503 sporadically</li><li>High request latency</li></ul><p><strong>Debugging:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Check error rate in last 5 minutes</span>
</span></span><span class=line><span class=cl>gcloud monitoring time-series list <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --filter<span class=o>=</span><span class=s1>&#39;metric.type=&#34;custom.googleapis.com/health_check_total&#34; AND metric.labels.status=&#34;error&#34;&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --interval-start-time<span class=o>=</span><span class=s2>&#34;5 minutes ago&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check for resource exhaustion (Cloud Run)</span>
</span></span><span class=line><span class=cl>gcloud run services describe boot-server --region<span class=o>=</span>&lt;region&gt; --format<span class=o>=</span>json <span class=p>|</span> jq <span class=s1>&#39;.status&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># For detailed resource metrics, check Cloud Monitoring dashboards</span>
</span></span></code></pre></div><p><strong>Common Causes:</strong></p><ul><li>Database connection pool exhausted</li><li>Memory pressure triggering GC pauses</li><li>High request volume overwhelming server</li><li>Dependency timeouts</li></ul><hr><h2 id=security-considerations>Security Considerations</h2><h3 id=unauthenticated-access>Unauthenticated Access</h3><p>Health check endpoints are <strong>intentionally unauthenticated</strong> to allow Cloud Run infrastructure to probe without credentials. This is safe because:</p><ol><li>Endpoints return only HTTP status codes (no response body)</li><li>No sensitive data is returned</li><li>Rate limiting prevents abuse</li><li>Endpoints are read-only</li></ol><h3 id=information-disclosure>Information Disclosure</h3><p>Health checks return only HTTP status codes with no response body, ensuring:</p><ul><li>No internal IP addresses disclosed</li><li>No error messages or stack traces exposed</li><li>No database connection strings revealed</li><li>No API keys or secrets leaked</li></ul><p>Detailed diagnostics are logged internally (not returned in response):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;severity&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Firestore connection failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;rpc error: code = PermissionDenied desc = Missing or insufficient permissions&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/Zaba505/infra aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Zaba505 | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/infra/pr-preview/pr-626/js/main.min.eb40505784d893e4b5c8dbd67b59c353e735d847f4ffbfe9d6921dec08dbacba.js integrity="sha256-60BQV4TYk+S1yNvWe1nDU+c12Ef0/7/p1pId7AjbrLo=" crossorigin=anonymous></script><script defer src=/infra/pr-preview/pr-626/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/infra/pr-preview/pr-626/js/tabpane-persist.js></script></body></html>