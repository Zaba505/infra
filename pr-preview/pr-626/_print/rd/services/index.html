<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/><link rel=alternate type=application/rss+xml href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/infra/pr-preview/pr-626/favicons/favicon.ico><link rel=apple-touch-icon href=/infra/pr-preview/pr-626/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-192x192.png sizes=192x192><title>Services | Zaba505's Home Lab</title><meta name=description content="Documentation for GCP Cloud Run microservices"><meta property="og:url" content="https://zaba505.github.io/infra/pr-preview/pr-626/rd/services/"><meta property="og:site_name" content="Zaba505's Home Lab"><meta property="og:title" content="Services"><meta property="og:description" content="Documentation for GCP Cloud Run microservices"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Services"><meta itemprop=description content="Documentation for GCP Cloud Run microservices"><meta itemprop=dateModified content="2025-11-24T02:39:09+00:00"><meta itemprop=wordCount content="64"><meta name=twitter:card content="summary"><meta name=twitter:title content="Services"><meta name=twitter:description content="Documentation for GCP Cloud Run microservices"><link rel=preload href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css as=style integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><link href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css rel=stylesheet integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/infra/pr-preview/pr-626/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Zaba505's Home Lab</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/infra/pr-preview/pr-626/offline-search-index.e23ce3be0306f2e9e79dffcc34c0dcfe.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/infra/pr-preview/pr-626/rd/services/>Return to the regular view of this page</a>.</p></div><h1 class=title>Services</h1><div class=lead>Documentation for GCP Cloud Run microservices</div><ul><li>1: <a href=#pg-4ce2427a9523f0ff078049ecbd3abed9>Boot Service</a></li><ul><li>1.1: <a href=#pg-45291fef6ecf8bf28903c56a01df0197>GET /boot.ipxe</a></li><li>1.2: <a href=#pg-49010b536d53c75102b246a30e774cb6>GET /asset/{boot_profile_id}/kernel</a></li><li>1.3: <a href=#pg-5874d39e2aede664368cbb3c16dfb190>GET /asset/{boot_profile_id}/initrd</a></li><li>1.4: <a href=#pg-a68897d6c4ed5365b996f10a697552e4>POST /api/v1/profiles</a></li><li>1.5: <a href=#pg-c820ed2058fb4588fc0c6b0b04c9d922>GET /api/v1/boot/{machine_id}/profile</a></li><li>1.6: <a href=#pg-24acd1badff3bbd194cd6cb31d3500cd>PUT /api/v1/boot/{machine_id}/profile</a></li><li>1.7: <a href=#pg-7cfea44dc34c48588b9295791a22e7b8>DELETE /api/v1/boot/{machine_id}/profile</a></li><li>1.8: <a href=#pg-4f0fd89b3946db2c7d5ec65a6880347c>GET /health/startup</a></li><li>1.9: <a href=#pg-c0c1465faa50c9fac75d82a69edfcd31>GET /health/liveness</a></li></ul><li>2: <a href=#pg-0fbab3644f8f6a3202867e1dbfd01125>Machine Service</a></li><ul><li>2.1: <a href=#pg-8161b025f023eea715281eff4619dd04>POST /api/v1/machines</a></li><li>2.2: <a href=#pg-ab6cbac66e8cf3fa0a5a8998d224f183>GET /api/v1/machines</a></li><li>2.3: <a href=#pg-5c3e0835220581b8bba64831f6f7f2be>GET /api/v1/machines/{id}</a></li><li>2.4: <a href=#pg-469e776cf0ea53aa67c4999bef12df53>PUT /api/v1/machines/{id}</a></li><li>2.5: <a href=#pg-8b6e001a582334f5057d88dd3d1a31c3>DELETE /api/v1/machines/{id}</a></li></ul></ul><div class=content><p>This section contains documentation for the Go microservices deployed to GCP Cloud Run as part of the home lab infrastructure.</p><h2 id=service-architecture>Service Architecture</h2><p>All services follow a consistent architecture pattern:</p><ul><li><strong>Framework</strong>: Built using <code>z5labs/humus</code> framework with OpenAPI-first design</li><li><strong>Runtime</strong>: Go 1.24+ deployed to GCP Cloud Run</li><li><strong>Observability</strong>: OpenTelemetry metrics, traces, and logs</li><li><strong>Health Checks</strong>: Standard <code>/health/startup</code> and <code>/health/liveness</code> endpoints</li><li><strong>Configuration</strong>: Embedded <code>config.yaml</code> with OpenAPI specifications</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4ce2427a9523f0ff078049ecbd3abed9>1 - Boot Service</h1><div class=lead>UEFI HTTP boot endpoints and boot profile management</div><p>The Boot Service is a custom Go microservice that provides UEFI HTTP boot endpoints for bare metal servers and manages boot profiles. It serves boot scripts, streams kernel/initrd assets, and handles boot profile administration (kernel/initrd upload, storage, and lifecycle management).</p><h2 id=architecture-overview>Architecture Overview</h2><p>The Boot Service is deployed on GCP Cloud Run and accessed through a WireGuard VPN tunnel from bare metal servers. It integrates with:</p><ul><li><strong>Machine Service</strong>: Retrieves machine hardware profiles by MAC address</li><li><strong>Cloud Storage</strong>: Stores and retrieves kernel/initrd blobs</li><li><strong>Firestore</strong>: Stores boot profile metadata</li><li><strong>Cloud Monitoring</strong>: OpenTelemetry observability with distributed tracing</li></ul><h2 id=related-documentation>Related Documentation</h2><ul><li><a href=../machine-mgmt/>Machine Service</a> - Machine hardware profile management</li><li><a href=../../adrs/0005-network-boot-infrastructure-gcp/>ADR-0005: Network Boot Infrastructure Implementation on Google Cloud</a> - Architecture decision and design rationale</li><li><a href=../../adrs/0002-network-boot-architecture/>ADR-0002: Network Boot Architecture</a> - Overall network boot strategy</li></ul><h2 id=api-endpoints>API Endpoints</h2><h3 id=uefi-http-boot-endpoints>UEFI HTTP Boot Endpoints</h3><p>Accessed by bare metal servers during boot process (via WireGuard VPN):</p><ul><li><a href=./boot-ipxe/>GET /boot.ipxe</a> - Serves iPXE boot scripts customized for the requesting machine</li><li><a href=./asset-kernel/>GET /asset/{boot_profile_id}/kernel</a> - Streams kernel images from Cloud Storage</li><li><a href=./asset-initrd/>GET /asset/{boot_profile_id}/initrd</a> - Streams initrd images from Cloud Storage</li></ul><h3 id=admin-api>Admin API</h3><p>Boot profile management endpoints for administrators:</p><ul><li><a href=./post-profiles/>POST /api/v1/profiles</a> - Create a new boot profile for a machine</li><li><a href=./get-profile/>GET /api/v1/boot/{machine_id}/profile</a> - Retrieve the active boot profile for a machine</li><li><a href=./put-profile/>PUT /api/v1/boot/{machine_id}/profile</a> - Update the boot profile for a machine</li><li><a href=./delete-profile/>DELETE /api/v1/boot/{machine_id}/profile</a> - Delete a machine&rsquo;s boot profile</li></ul><h3 id=health-check-endpoints>Health Check Endpoints</h3><p>Standard Cloud Run health endpoints:</p><ul><li><a href=./health-startup/>GET /health/startup</a> - Startup probe endpoint</li><li><a href=./health-liveness/>GET /health/liveness</a> - Liveness probe endpoint</li></ul><h2 id=security-model>Security Model</h2><h3 id=vpn-based-access-control>VPN-Based Access Control</h3><p>Since HP DL360 Gen 9 servers do not support client-side TLS certificates for UEFI HTTP boot, all boot traffic is secured via WireGuard VPN:</p><ul><li><strong>Boot Endpoints</strong>: Only accessible through WireGuard tunnel (source IP validation)</li><li><strong>Transport Security</strong>: WireGuard provides mutual authentication and encryption</li></ul><h3 id=authentication-methods>Authentication Methods</h3><ul><li><strong>UEFI Boot Endpoints</strong>: VPN source IP validation (bare metal servers)</li><li><strong>Health Checks</strong>: Unauthenticated (used by Cloud Run for liveness/startup probes)</li></ul><h2 id=common-patterns>Common Patterns</h2><h3 id=error-responses>Error Responses</h3><p>All API endpoints follow the RFC 7807 Problem Details standard (see <a href=../../adrs/0007-standard-api-error-response/>ADR-0007</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;https://api.example.com/errors/resource-not-found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Resource Not Found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;Machine with MAC address aa:bb:cc:dd:ee:ff not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instance&#34;</span><span class=p>:</span> <span class=s2>&#34;/api/v1/boot/aa:bb:cc:dd:ee:ff/profile&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;aa:bb:cc:dd:ee:ff&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Error responses use <code>Content-Type: application/problem+json</code>.</p><h3 id=standard-http-status-codes>Standard HTTP Status Codes</h3><ul><li><code>200 OK</code> - Successful request</li><li><code>201 Created</code> - Resource created successfully</li><li><code>204 No Content</code> - Successful deletion</li><li><code>400 Bad Request</code> - Invalid request parameters</li><li><code>401 Unauthorized</code> - Missing or invalid authentication</li><li><code>403 Forbidden</code> - Insufficient permissions</li><li><code>404 Not Found</code> - Resource not found</li><li><code>409 Conflict</code> - Resource already exists</li><li><code>422 Unprocessable Entity</code> - Validation error</li><li><code>500 Internal Server Error</code> - Server error</li></ul><h3 id=content-types>Content Types</h3><ul><li><code>application/json</code> - JSON responses (admin API)</li><li><code>application/problem+json</code> - RFC 7807 error responses</li><li><code>text/plain</code> - iPXE boot scripts</li><li><code>application/octet-stream</code> - Binary boot assets (kernel, initrd)</li><li><code>text/cloud-config</code> - Cloud-init configuration files</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-45291fef6ecf8bf28903c56a01df0197>1.1 - GET /boot.ipxe</h1><div class=lead>Serves iPXE boot scripts customized for the requesting machine</div><p>Serves iPXE boot scripts customized for the requesting machine based on its MAC address. This endpoint is accessed by bare metal servers (HP DL360 Gen 9) during the UEFI HTTP boot process through the WireGuard VPN tunnel.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Service
    participant MachineAPI as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;Boot: GET /boot.ipxe?mac=52:54:00:12:34:56
    Boot-&gt;&gt;Boot: Validate MAC address format
    Boot-&gt;&gt;MachineAPI: GET /api/v1/machines?mac=52:54:00:12:34:56
    MachineAPI-&gt;&gt;DB: Query machine by NIC MAC
    DB--&gt;&gt;MachineAPI: Machine profile (machine_id)
    MachineAPI--&gt;&gt;Boot: Machine profile
    Boot-&gt;&gt;DB: Query boot profile by machine_id
    DB--&gt;&gt;Boot: Boot profile (profile_id, kernel_id, initrd_id, kernel args)
    Boot-&gt;&gt;Boot: Generate iPXE script with profile_id
    Boot--&gt;&gt;Client: 200 OK (iPXE script)</pre><h2 id=request>Request</h2><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>mac</code></td><td>string</td><td>Yes</td><td>MAC address of the requesting machine (format: <code>aa:bb:cc:dd:ee:ff</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/boot.ipxe?mac=52:54:00:12:34:56</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response Example (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>#!ipxe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Boot configuration for node-01 (52:54:00:12:34:56)
</span></span><span class=line><span class=cl># Boot Profile ID: 018c7dbd-a1b2-7000-8000-987654321def
</span></span><span class=line><span class=cl># Generated: 2025-11-19T06:00:00Z
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kernel /asset/018c7dbd-a1b2-7000-8000-987654321def/kernel console=tty0 console=ttyS0 ip=dhcp
</span></span><span class=line><span class=cl>initrd /asset/018c7dbd-a1b2-7000-8000-987654321def/initrd
</span></span><span class=line><span class=cl>boot
</span></span></code></pre></div><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: text/plain; charset=utf-8</code></li><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>400 Bad Request</td><td>Missing or invalid MAC address</td><td><code>{"error": {"code": "INVALID_MAC_ADDRESS", "message": "MAC address must be in format aa:bb:cc:dd:ee:ff"}}</code></td></tr><tr><td>404 Not Found</td><td>No boot configuration found for MAC</td><td><code>{"error": {"code": "MACHINE_NOT_CONFIGURED", "message": "No boot configuration found for MAC 52:54:00:12:34:56"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Database or template error</td><td><code>{"error": {"code": "INTERNAL_ERROR", "message": "Failed to generate boot script"}}</code></td></tr></tbody></table><h2 id=boot-script-variables>Boot Script Variables</h2><p>The iPXE script may include the following dynamic values:</p><ul><li>Machine-specific kernel parameters</li><li>Asset download URLs (using boot profile ID format)</li><li>Network configuration parameters</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=vpn-source-ip-validation>VPN Source IP Validation</h3><p>All boot endpoints validate that requests originate from the WireGuard VPN subnet:</p><ul><li><strong>Allowed CIDR</strong>: <code>10.x.x.0/24</code> (WireGuard VPN network)</li><li><strong>Validation</strong>: Performed at Cloud Run ingress or application layer</li><li><strong>Rejection</strong>: Requests from outside VPN return <code>403 Forbidden</code></li></ul><h3 id=rate-limiting>Rate Limiting</h3><p>To prevent abuse, boot endpoints are rate-limited:</p><ul><li><strong>Boot Script</strong>: 10 requests/minute per MAC address</li></ul><h2 id=observability>Observability</h2><p>All boot endpoint requests are instrumented with OpenTelemetry following HTTP semantic conventions:</p><ul><li><strong>Metrics</strong>: OpenTelemetry HTTP server metrics (request count, duration, size)<ul><li><code>http.server.request.duration</code> - Request duration histogram</li><li><code>http.server.request.body.size</code> - Request body size</li><li><code>http.server.response.body.size</code> - Response body size</li></ul></li><li><strong>Traces</strong>: End-to-end tracing from request to database retrieval<ul><li>HTTP server span captures request details (method, route, status code)</li><li>Child spans for database queries and Machine Service API calls</li></ul></li><li><strong>Logs</strong>: Structured logs with MAC address, boot profile ID, response status</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-49010b536d53c75102b246a30e774cb6>1.2 - GET /asset/{boot_profile_id}/kernel</h1><div class=lead>Streams kernel images from Cloud Storage for the boot process</div><p>Streams kernel images from Cloud Storage for the boot process. This endpoint is accessed by bare metal servers during UEFI HTTP boot through the WireGuard VPN tunnel.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Service
    participant Storage as Cloud Storage
    participant DB as Firestore

    Client-&gt;&gt;Boot: GET /asset/018c7dbd-a1b2-7000-8000-987654321def/kernel
    Boot-&gt;&gt;Boot: Validate UUIDv7 format
    Boot-&gt;&gt;DB: Query boot profile by ID
    DB--&gt;&gt;Boot: Boot profile (kernel_id)
    Boot-&gt;&gt;Storage: GET gs://bucket/blobs/{kernel_id}
    Storage--&gt;&gt;Boot: Kernel data stream
    Boot--&gt;&gt;Client: 200 OK (kernel stream)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>boot_profile_id</code></td><td>string (UUIDv7)</td><td>Yes</td><td>Boot profile identifier (UUIDv7 format: <code>018c7dbd-a1b2-7000-8000-987654321def</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/asset/018c7dbd-a1b2-7000-8000-987654321def/kernel</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response Example (200 OK):</strong></p><p>Binary kernel image streamed from Cloud Storage.</p><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: application/octet-stream</code></li><li><code>Content-Length: 8388608</code> (actual kernel size in bytes)</li><li><code>Cache-Control: public, max-age=3600</code></li><li><code>ETag: "abc123..."</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Kernel image not found</td><td><code>{"error": {"code": "KERNEL_NOT_FOUND", "message": "Kernel image not found for boot profile"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Cloud Storage error</td><td><code>{"error": {"code": "STORAGE_ERROR", "message": "Failed to retrieve kernel from storage"}}</code></td></tr></tbody></table><h2 id=performance-characteristics>Performance Characteristics</h2><ul><li><strong>Streaming</strong>: File is streamed directly from Cloud Storage (no buffering in memory)</li><li><strong>Target Latency</strong>: &lt; 100ms to first byte</li><li><strong>Typical Size</strong>: 8-15 MB for Linux kernels</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=vpn-source-ip-validation>VPN Source IP Validation</h3><p>All boot endpoints validate that requests originate from the WireGuard VPN subnet:</p><ul><li><strong>Allowed CIDR</strong>: <code>10.x.x.0/24</code> (WireGuard VPN network)</li><li><strong>Validation</strong>: Performed at Cloud Run ingress or application layer</li><li><strong>Rejection</strong>: Requests from outside VPN return <code>403 Forbidden</code></li></ul><h3 id=rate-limiting>Rate Limiting</h3><p>To prevent abuse, asset download endpoints are rate-limited:</p><ul><li><strong>Asset Downloads</strong>: 5 concurrent downloads per MAC address</li></ul><h3 id=asset-integrity>Asset Integrity</h3><p>Boot assets are validated for integrity:</p><ul><li><strong>Checksums</strong>: SHA-256 checksums stored in Firestore</li><li><strong>Verification</strong>: Computed on upload, verified on download (optional)</li><li><strong>ETag Headers</strong>: Enable client-side caching and integrity checks</li></ul><h2 id=observability>Observability</h2><p>All boot endpoint requests are instrumented with OpenTelemetry following HTTP semantic conventions:</p><ul><li><strong>Metrics</strong>: OpenTelemetry HTTP server metrics<ul><li><code>http.server.request.duration</code> - Request duration histogram</li><li><code>http.server.response.body.size</code> - Response body size (tracks bytes transferred)</li></ul></li><li><strong>Traces</strong>: End-to-end tracing from request to Cloud Storage retrieval<ul><li>HTTP server span captures request details (method, route, status code)</li><li>Child spans for database queries and Cloud Storage operations</li></ul></li><li><strong>Logs</strong>: Structured logs with boot profile ID, kernel ID, response status</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5874d39e2aede664368cbb3c16dfb190>1.3 - GET /asset/{boot_profile_id}/initrd</h1><div class=lead>Streams initial ramdisk images from Cloud Storage for the boot process</div><p>Streams initial ramdisk (initrd) images from Cloud Storage for the boot process. This endpoint is accessed by bare metal servers during UEFI HTTP boot through the WireGuard VPN tunnel.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Bare Metal Server
    participant Boot as Boot Service
    participant Storage as Cloud Storage
    participant DB as Firestore

    Client-&gt;&gt;Boot: GET /asset/018c7dbd-a1b2-7000-8000-987654321def/initrd
    Boot-&gt;&gt;Boot: Validate UUIDv7 format
    Boot-&gt;&gt;DB: Query boot profile by ID
    DB--&gt;&gt;Boot: Boot profile (initrd_id)
    Boot-&gt;&gt;Storage: GET gs://bucket/blobs/{initrd_id}
    Storage--&gt;&gt;Boot: Initrd data stream
    Boot--&gt;&gt;Client: 200 OK (initrd stream)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>boot_profile_id</code></td><td>string (UUIDv7)</td><td>Yes</td><td>Boot profile identifier (UUIDv7 format: <code>018c7dbd-a1b2-7000-8000-987654321def</code>)</td></tr></tbody></table><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/asset/018c7dbd-a1b2-7000-8000-987654321def/initrd</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.internal</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response Example (200 OK):</strong></p><p>Binary initrd image streamed from Cloud Storage.</p><p><strong>Response Headers:</strong></p><ul><li><code>Content-Type: application/octet-stream</code></li><li><code>Content-Length: 52428800</code> (actual initrd size in bytes)</li><li><code>Cache-Control: public, max-age=3600</code></li><li><code>ETag: "def456..."</code></li></ul><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Initrd image not found</td><td><code>{"error": {"code": "INITRD_NOT_FOUND", "message": "Initrd image not found for boot profile"}}</code></td></tr><tr><td>500 Internal Server Error</td><td>Cloud Storage error</td><td><code>{"error": {"code": "STORAGE_ERROR", "message": "Failed to retrieve initrd from storage"}}</code></td></tr></tbody></table><h2 id=performance-characteristics>Performance Characteristics</h2><ul><li><strong>Streaming</strong>: File is streamed directly from Cloud Storage (no buffering in memory)</li><li><strong>Target Latency</strong>: &lt; 100ms to first byte</li><li><strong>Typical Size</strong>: 50-150 MB for Linux initrd images</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=vpn-source-ip-validation>VPN Source IP Validation</h3><p>All boot endpoints validate that requests originate from the WireGuard VPN subnet:</p><ul><li><strong>Allowed CIDR</strong>: <code>10.x.x.0/24</code> (WireGuard VPN network)</li><li><strong>Validation</strong>: Performed at Cloud Run ingress or application layer</li><li><strong>Rejection</strong>: Requests from outside VPN return <code>403 Forbidden</code></li></ul><h3 id=rate-limiting>Rate Limiting</h3><p>To prevent abuse, asset download endpoints are rate-limited:</p><ul><li><strong>Asset Downloads</strong>: 5 concurrent downloads per MAC address</li></ul><h3 id=asset-integrity>Asset Integrity</h3><p>Boot assets are validated for integrity:</p><ul><li><strong>Checksums</strong>: SHA-256 checksums stored in Firestore</li><li><strong>Verification</strong>: Computed on upload, verified on download (optional)</li><li><strong>ETag Headers</strong>: Enable client-side caching and integrity checks</li></ul><h2 id=observability>Observability</h2><p>All boot endpoint requests are instrumented with OpenTelemetry following HTTP semantic conventions:</p><ul><li><strong>Metrics</strong>: OpenTelemetry HTTP server metrics<ul><li><code>http.server.request.duration</code> - Request duration histogram</li><li><code>http.server.response.body.size</code> - Response body size (tracks bytes transferred)</li></ul></li><li><strong>Traces</strong>: End-to-end tracing from request to Cloud Storage retrieval<ul><li>HTTP server span captures request details (method, route, status code)</li><li>Child spans for database queries and Cloud Storage operations</li></ul></li><li><strong>Logs</strong>: Structured logs with boot profile ID, initrd ID, response status</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a68897d6c4ed5365b996f10a697552e4>1.4 - POST /api/v1/profiles</h1><div class=lead>Create a new boot profile for a machine</div><p>Create a new boot profile for a machine. If the machine already has a boot profile, this operation will fail - use PUT to update instead.</p><h2 id=cloud-storage-structure>Cloud Storage Structure</h2><p>Kernel and initrd binaries are stored in Google Cloud Storage using their UUIDv7 identifiers as object keys:</p><pre tabindex=0><code>gs://{bucket}/blobs/{kernel_id}
gs://{bucket}/blobs/{initrd_id}
</code></pre><p>For example:</p><pre tabindex=0><code>gs://boot-server-blobs/blobs/018c7dbd-b100-7000-8000-123456789abc
gs://boot-server-blobs/blobs/018c7dbd-b200-7000-8000-987654321fed
</code></pre><p>The UUIDv7 identifiers are generated server-side during upload, ensuring:</p><ul><li>Globally unique object keys</li><li>Time-ordered storage (UUIDv7 timestamp prefix)</li><li>No namespace collisions between profiles</li></ul><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant Boot as Boot Service
    participant Storage as Cloud Storage
    participant DB as Firestore

    Client-&gt;&gt;Boot: POST /api/v1/profiles (multipart/form-data)
    Boot-&gt;&gt;DB: Check if machine already has a boot profile
    DB--&gt;&gt;Boot: No existing profile
    Boot-&gt;&gt;Boot: Generate UUIDv7 for profile
    Boot-&gt;&gt;Boot: Generate UUIDv7 for kernel blob
    Boot-&gt;&gt;Boot: Generate UUIDv7 for initrd blob
    Boot-&gt;&gt;Storage: PUT gs://bucket/blobs/{kernel_id}
    Storage--&gt;&gt;Boot: Kernel stored
    Boot-&gt;&gt;Storage: PUT gs://bucket/blobs/{initrd_id}
    Storage--&gt;&gt;Boot: Initrd stored
    Boot-&gt;&gt;DB: Store profile metadata (profile_id, kernel_id, initrd_id, machine_id)
    DB--&gt;&gt;Boot: Profile created
    Boot--&gt;&gt;Client: 201 Created (profile metadata with IDs)</pre><h2 id=request>Request</h2><p><strong>Request Body (multipart/form-data):</strong></p><p>Form fields:</p><ul><li><code>machine_id</code> (text): Machine identifier (UUIDv7)</li><li><code>kernel</code> (file): Kernel image file</li><li><code>initrd</code> (file): Initrd image file</li><li><code>kernel_args</code> (JSON array): Kernel command-line arguments</li></ul><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api/v1/profiles</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;machine_id&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>018c7dbd-c000-7000-8000-fedcba987654
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;kernel&#34;; filename=&#34;vmlinuz&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;kernel binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;initrd&#34;; filename=&#34;initrd.img&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;initrd binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;kernel_args&#34;
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[&#34;console=tty0&#34;, &#34;console=ttyS0&#34;, &#34;ip=dhcp&#34;]
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW--
</span></span></code></pre></div><p><strong>Request Headers:</strong></p><ul><li><code>Content-Type: multipart/form-data</code></li></ul><h2 id=response>Response</h2><p><strong>Response (201 Created):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;machine_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b100-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;args&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span> <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span> <span class=s2>&#34;ip=dhcp&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b200-7000-8000-987654321fed&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>400 Bad Request</td><td>Invalid request body or missing required fields</td></tr><tr><td>409 Conflict</td><td>Machine already has a boot profile (use PUT to update)</td></tr><tr><td>422 Unprocessable Entity</td><td>Validation error (file too large, invalid JSON, machine_id not found)</td></tr></tbody></table><h2 id=data-models>Data Models</h2><p>All data models are defined as Protocol Buffer (protobuf) messages and stored in Firestore.</p><h3 id=boot-profile>Boot Profile</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Kernel</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>              <span class=c1>// UUIDv7 blob identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>string</span> <span class=n>args</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>   <span class=c1>// Kernel command-line arguments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Initrd</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>              <span class=c1>// UUIDv7 blob identifier
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>BootProfile</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>              <span class=c1>// UUIDv7 identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>machine_id</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>      <span class=c1>// Reference to machine (UUIDv7) - unique constraint
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Kernel</span> <span class=n>kernel</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>          <span class=c1>// Kernel configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Initrd</span> <span class=n>initrd</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>          <span class=c1>// Initrd configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p><strong>Note</strong>: The <code>machine_id</code> field has a unique constraint in Firestore, ensuring each machine has exactly one active boot profile.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c820ed2058fb4588fc0c6b0b04c9d922>1.5 - GET /api/v1/boot/{machine_id}/profile</h1><div class=lead>Retrieve the active boot profile for a specific machine</div><p>Retrieve the active boot profile for a specific machine.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant Boot as Boot Service
    participant DB as Firestore

    Client-&gt;&gt;Boot: GET /api/v1/boot/{machine_id}/profile
    Boot-&gt;&gt;DB: Query active boot profile for machine
    DB--&gt;&gt;Boot: Boot profile
    Boot--&gt;&gt;Client: 200 OK (boot profile)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>machine_id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/boot/018c7dbd-c000-7000-8000-fedcba987654/profile</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;machine_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b100-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;args&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span> <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span> <span class=s2>&#34;ip=dhcp&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b200-7000-8000-987654321fed&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine not found or has no boot profile</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-24acd1badff3bbd194cd6cb31d3500cd>1.6 - PUT /api/v1/boot/{machine_id}/profile</h1><div class=lead>Update the boot profile for a machine</div><p>Update the boot profile for a machine (replaces the existing profile).</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant Boot as Boot Service
    participant Storage as Cloud Storage
    participant DB as Firestore

    Client-&gt;&gt;Boot: PUT /api/v1/boot/{machine_id}/profile
    Boot-&gt;&gt;DB: Get current active profile
    DB--&gt;&gt;Boot: Current profile (old kernel_id, old initrd_id)
    Boot-&gt;&gt;Boot: Generate UUIDs for new kernel/initrd
    Boot-&gt;&gt;Storage: PUT new kernel/initrd blobs
    Storage--&gt;&gt;Boot: Blobs stored
    Boot-&gt;&gt;DB: Update boot profile (replace kernel_id, initrd_id, args)
    DB--&gt;&gt;Boot: Profile updated
    Boot-&gt;&gt;Storage: DELETE old kernel/initrd blobs
    Boot--&gt;&gt;Client: 200 OK (updated profile)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>machine_id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Request Body (multipart/form-data):</strong></p><p>Form fields:</p><ul><li><code>kernel</code> (file): Kernel image file</li><li><code>initrd</code> (file): Initrd image file</li><li><code>kernel_args</code> (JSON array): Kernel command-line arguments</li></ul><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>PUT</span> <span class=nn>/api/v1/boot/018c7dbd-c000-7000-8000-fedcba987654/profile</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;kernel&#34;; filename=&#34;vmlinuz&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;kernel binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;initrd&#34;; filename=&#34;initrd.img&#34;
</span></span><span class=line><span class=cl>Content-Type: application/octet-stream
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;initrd binary data&gt;
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;kernel_args&#34;
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[&#34;console=tty0&#34;, &#34;console=ttyS0&#34;, &#34;ip=dhcp&#34;]
</span></span><span class=line><span class=cl>------WebKitFormBoundary7MA4YWxkTrZu0gW--
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-abcdef123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;machine_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kernel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b100-7000-8000-123456789abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;args&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;console=tty0&#34;</span><span class=p>,</span> <span class=s2>&#34;console=ttyS0&#34;</span><span class=p>,</span> <span class=s2>&#34;ip=dhcp&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;initrd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-b200-7000-8000-987654321fed&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine not found or has no boot profile</td></tr><tr><td>422 Unprocessable Entity</td><td>Validation error</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-7cfea44dc34c48588b9295791a22e7b8>1.7 - DELETE /api/v1/boot/{machine_id}/profile</h1><div class=lead>Delete a machine&rsquo;s boot profile and its associated blobs</div><p>Delete a machine&rsquo;s boot profile and its associated blobs.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant Boot as Boot Service
    participant Storage as Cloud Storage
    participant DB as Firestore

    Client-&gt;&gt;Boot: DELETE /api/v1/boot/{machine_id}/profile
    Boot-&gt;&gt;DB: Get kernel_id and initrd_id
    DB--&gt;&gt;Boot: Blob IDs
    Boot-&gt;&gt;Storage: DELETE gs://bucket/blobs/{kernel_id}
    Boot-&gt;&gt;Storage: DELETE gs://bucket/blobs/{initrd_id}
    Boot-&gt;&gt;DB: Delete boot profile
    Boot--&gt;&gt;Client: 204 No Content</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>machine_id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>DELETE</span> <span class=nn>/api/v1/boot/018c7dbd-c000-7000-8000-fedcba987654/profile</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (204 No Content):</strong></p><p>Empty response body.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine not found or has no boot profile</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4f0fd89b3946db2c7d5ec65a6880347c>1.8 - GET /health/startup</h1><div class=lead>Startup probe endpoint for Cloud Run</div><p>Indicates whether the application has completed initialization and is ready to receive traffic.</p><h2 id=request>Request</h2><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/health/startup</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><p>Empty response body with HTTP 200 status code.</p><p><strong>Response (503 Service Unavailable):</strong></p><p>Empty response body with HTTP 503 status code.</p><p><strong>Response Headers:</strong></p><ul><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><h2 id=startup-check-components>Startup Check Components</h2><ol><li><strong>Firestore Connection</strong> - Verifies database connectivity</li><li><strong>Cloud Storage Access</strong> - Validates access to boot image buckets</li></ol><h2 id=cloud-run-configuration>Cloud Run Configuration</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>startupProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health/startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><h2 id=behavior>Behavior</h2><ul><li><strong>Success (200)</strong>: Application is fully initialized and ready to serve requests</li><li><strong>Failure (503)</strong>: Application is still starting up or encountered initialization errors</li><li><strong>Timeout</strong>: After 30 seconds of no response, Cloud Run considers startup failed</li></ul><h2 id=observability>Observability</h2><p><strong>Metrics:</strong></p><ul><li><code>health_check_total{probe="startup",status="ok"}</code> - Successful startup checks</li><li><code>health_check_total{probe="startup",status="error"}</code> - Failed startup checks</li><li><code>health_check_duration_ms{probe="startup"}</code> - Startup check duration</li></ul><p><strong>Structured Logs:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;severity&#34;</span><span class=p>:</span> <span class=s2>&#34;INFO&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Health check completed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;probe&#34;</span><span class=p>:</span> <span class=s2>&#34;startup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;ok&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;duration_ms&#34;</span><span class=p>:</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Alerts:</strong></p><ul><li><strong>Startup Failure</strong>: Alert if startup check fails for > 1 minute</li></ul><h2 id=testing>Testing</h2><h3 id=manual-testing>Manual Testing</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v http://localhost:8080/health/startup
</span></span></code></pre></div><h3 id=automated-testing>Automated Testing</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>TestHealthStartup</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;http://localhost:8080/health/startup&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>require</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=troubleshooting>Troubleshooting</h2><h3 id=startup-check-never-succeeds>Startup Check Never Succeeds</h3><p><strong>Symptoms:</strong></p><ul><li>Container restarts repeatedly</li><li>Cloud Run shows &ldquo;unhealthy&rdquo; status</li><li>Startup probe returns 503</li></ul><p><strong>Debugging:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Check Cloud Run logs for startup errors</span>
</span></span><span class=line><span class=cl>gcloud logging <span class=nb>read</span> <span class=s2>&#34;resource.type=cloud_run_revision AND labels.service_name=boot-server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --limit <span class=m>50</span> --format json <span class=p>|</span> jq <span class=s1>&#39;.[] | select(.jsonPayload.probe==&#34;startup&#34;)&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test locally with debug logging</span>
</span></span><span class=line><span class=cl><span class=nv>DEBUG</span><span class=o>=</span><span class=nb>true</span> go run main.go
</span></span></code></pre></div><p><strong>Common Causes:</strong></p><ul><li>Firestore credentials not configured</li><li>Cloud Storage bucket permissions missing</li><li>Network connectivity issues</li><li>Timeout too short for slow dependencies</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c0c1465faa50c9fac75d82a69edfcd31>1.9 - GET /health/liveness</h1><div class=lead>Liveness probe endpoint for Cloud Run</div><p>Indicates whether the application is alive and healthy. Used by Cloud Run to detect and restart unhealthy instances.</p><h2 id=request>Request</h2><p><strong>Request Example:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/health/liveness</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>boot.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><p>Empty response body with HTTP 200 status code.</p><p><strong>Response (503 Service Unavailable):</strong></p><p>Empty response body with HTTP 503 status code.</p><p><strong>Response Headers:</strong></p><ul><li><code>Cache-Control: no-cache, no-store, must-revalidate</code></li></ul><h2 id=liveness-check-components>Liveness Check Components</h2><ol><li><strong>HTTP Server Health</strong> - Verifies the HTTP server is responsive</li><li><strong>Basic health validation</strong> - Ensures the application can handle requests</li></ol><h2 id=cloud-run-configuration>Cloud Run Configuration</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health/liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><h2 id=behavior>Behavior</h2><ul><li><strong>Success (200)</strong>: Application is healthy and functioning normally</li><li><strong>Failure (503)</strong>: Application is unhealthy and should be restarted</li><li><strong>Consecutive Failures</strong>: After 3 consecutive failures (30 seconds), Cloud Run restarts the instance</li></ul><h2 id=graceful-degradation>Graceful Degradation</h2><p>The health check is designed with graceful degradation in mind:</p><ul><li><strong>Critical Failures</strong>: Return 503 and trigger restart (e.g., database connection lost)</li><li><strong>Non-Critical Failures</strong>: Log warnings but return 200 (e.g., temporary Cloud Storage timeout)</li><li><strong>Transient Errors</strong>: Retry internally before reporting failure</li></ul><h2 id=observability>Observability</h2><p><strong>Metrics:</strong></p><ul><li><code>health_check_total{probe="liveness",status="ok"}</code> - Successful liveness checks</li><li><code>health_check_total{probe="liveness",status="error"}</code> - Failed liveness checks</li><li><code>health_check_duration_ms{probe="liveness"}</code> - Liveness check duration</li></ul><p><strong>Structured Logs:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;severity&#34;</span><span class=p>:</span> <span class=s2>&#34;INFO&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-11-19T06:00:00Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Health check completed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;probe&#34;</span><span class=p>:</span> <span class=s2>&#34;liveness&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;ok&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;duration_ms&#34;</span><span class=p>:</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Alerts:</strong></p><ul><li><strong>Liveness Failure</strong>: Alert if liveness check fails 3+ times consecutively</li><li><strong>High Restart Rate</strong>: Alert if container restarts > 3 times in 5 minutes</li></ul><h2 id=testing>Testing</h2><h3 id=manual-testing>Manual Testing</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v http://localhost:8080/health/liveness
</span></span></code></pre></div><h3 id=load-testing>Load Testing</h3><p>Health check endpoints should handle high request rates without degrading application performance:</p><ul><li><strong>Target</strong>: 100 requests/second sustained</li><li><strong>Timeout</strong>: &lt; 10ms average response time</li><li><strong>Resource Impact</strong>: &lt; 1% CPU, &lt; 10MB memory overhead</li></ul><h2 id=troubleshooting>Troubleshooting</h2><h3 id=liveness-check-intermittent-failures>Liveness Check Intermittent Failures</h3><p><strong>Symptoms:</strong></p><ul><li>Occasional container restarts</li><li>Liveness probe returns 503 sporadically</li><li>High request latency</li></ul><p><strong>Debugging:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Check error rate in last 5 minutes</span>
</span></span><span class=line><span class=cl>gcloud monitoring time-series list <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --filter<span class=o>=</span><span class=s1>&#39;metric.type=&#34;custom.googleapis.com/health_check_total&#34; AND metric.labels.status=&#34;error&#34;&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --interval-start-time<span class=o>=</span><span class=s2>&#34;5 minutes ago&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check for resource exhaustion (Cloud Run)</span>
</span></span><span class=line><span class=cl>gcloud run services describe boot-server --region<span class=o>=</span>&lt;region&gt; --format<span class=o>=</span>json <span class=p>|</span> jq <span class=s1>&#39;.status&#39;</span>
</span></span></code></pre></div><p><strong>Common Causes:</strong></p><ul><li>Database connection pool exhausted</li><li>Memory pressure triggering GC pauses</li><li>High request volume overwhelming server</li><li>Dependency timeouts</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=unauthenticated-access>Unauthenticated Access</h3><p>Health check endpoints are <strong>intentionally unauthenticated</strong> to allow Cloud Run infrastructure to probe without credentials. This is safe because:</p><ol><li>Endpoints return only HTTP status codes (no response body)</li><li>No sensitive data is returned</li><li>Rate limiting prevents abuse</li><li>Endpoints are read-only</li></ol><h3 id=information-disclosure>Information Disclosure</h3><p>Health checks return only HTTP status codes with no response body, ensuring:</p><ul><li>No internal IP addresses disclosed</li><li>No error messages or stack traces exposed</li><li>No database connection strings revealed</li><li>No API keys or secrets leaked</li></ul><p>Detailed diagnostics are logged internally (not returned in response):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;severity&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Firestore connection failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;rpc error: code = PermissionDenied desc = Missing or insufficient permissions&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0fbab3644f8f6a3202867e1dbfd01125>2 - Machine Service</h1><div class=lead>Service for managing machine hardware profiles</div><p>The Machine Service is a REST API that manages machine hardware profiles for the network boot infrastructure. It stores machine specifications (CPUs, memory, NICs, drives, accelerators) in Firestore and is queried by the Boot Service during boot operations and by administrators for configuration management.</p><h2 id=architecture>Architecture</h2><p>The service is responsible for:</p><ul><li><strong>Machine Profile Management</strong>: Creating, listing, retrieving, updating, and deleting machine hardware profiles</li><li><strong>Hardware Specification Storage</strong>: Storing detailed hardware specifications in Firestore</li><li><strong>Machine Lookup</strong>: Providing machine profile queries by ID or NIC MAC address</li></ul><h2 id=components>Components</h2><ul><li><strong>Firestore</strong>: Stores machine hardware profiles</li><li><strong>REST API</strong>: HTTP endpoints for machine profile management</li></ul><h2 id=clients>Clients</h2><p>The service is consumed by:</p><ol><li><strong>Boot Service</strong>: Queries machine profiles by MAC address during boot operations</li><li><strong>Admin Tools</strong>: CLI or web interfaces for managing machine inventory</li><li><strong>Monitoring Systems</strong>: Hardware inventory and asset management tools</li></ol><h2 id=deployment>Deployment</h2><ul><li><strong>Platform</strong>: GCP Cloud Run</li><li><strong>Scaling</strong>: Automatic scaling based on request load</li><li><strong>Availability</strong>: Min instances = 1 for low-latency responses</li><li><strong>Region</strong>: Same region as Boot Service for minimal latency</li></ul><h2 id=api-endpoints>API Endpoints</h2><h3 id=machine-management>Machine Management</h3><ul><li><a href=./post-machines/>POST /api/v1/machines</a> - Register a new machine with hardware specifications</li><li><a href=./get-machines/>GET /api/v1/machines</a> - List all registered machines</li><li><a href=./get-machine/>GET /api/v1/machines/{id}</a> - Retrieve a specific machine by ID</li><li><a href=./put-machine/>PUT /api/v1/machines/{id}</a> - Update a machine&rsquo;s hardware profile</li><li><a href=./delete-machine/>DELETE /api/v1/machines/{id}</a> - Delete a machine registration</li></ul><h2 id=rate-limiting>Rate Limiting</h2><p>Admin API endpoints are rate-limited to prevent abuse:</p><ul><li><strong>Per User/Service Account</strong>: 100 requests/minute</li><li><strong>Per IP Address</strong>: 300 requests/minute</li><li><strong>Global</strong>: 1000 requests/minute</li></ul><p>Rate limit headers are included in responses:</p><pre tabindex=0><code>X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1700000000
</code></pre><p>When rate limit is exceeded, API returns <code>429 Too Many Requests</code> using RFC 7807 Problem Details format (see <a href=../../adrs/0007-standard-api-error-response/>ADR-0007</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;https://api.example.com/errors/rate-limit-exceeded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Rate Limit Exceeded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>429</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;Rate limit exceeded. Try again in 30 seconds.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instance&#34;</span><span class=p>:</span> <span class=s2>&#34;/api/v1/machines&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;retry_after&#34;</span><span class=p>:</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>All error responses use <code>Content-Type: application/problem+json</code>.</p><h2 id=versioning>Versioning</h2><p>The Admin API uses URL versioning (<code>/api/v1/</code>):</p><ul><li><strong>Current Version</strong>: v1</li><li><strong>Deprecation Policy</strong>: Minimum 6 months notice before version deprecation</li><li><strong>Version Header</strong>: <code>X-API-Version: v1</code> included in all responses</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8161b025f023eea715281eff4619dd04>2.1 - POST /api/v1/machines</h1><div class=lead>Register a new machine with hardware specifications</div><p>Register a new machine with hardware specifications.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;API: POST /api/v1/machines
    API-&gt;&gt;API: Generate machine id (UUIDv7)
    API-&gt;&gt;API: Validate machine profile
    API-&gt;&gt;DB: Insert machine profile
    DB--&gt;&gt;API: Machine created
    API--&gt;&gt;Client: 201 Created (machine id)</pre><h2 id=request>Request</h2><p><strong>Request Body:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpus&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;manufacturer&#34;</span><span class=p>:</span> <span class=s2>&#34;Intel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;clock_frequency&#34;</span><span class=p>:</span> <span class=mi>2400000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;cores&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;memory_modules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;accelerators&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;nics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;drives&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;capacity&#34;</span><span class=p>:</span> <span class=mi>500107862016</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (201 Created):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><p>All error responses follow RFC 7807 Problem Details format (see <a href=../../adrs/0007-standard-api-error-response/>ADR-0007</a>) with <code>Content-Type: application/problem+json</code>.</p><p><strong>400 Bad Request</strong> - Invalid request body or missing required fields:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;https://api.example.com/errors/validation-error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Validation Error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;The request body failed validation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instance&#34;</span><span class=p>:</span> <span class=s2>&#34;/api/v1/machines&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;invalid_fields&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;field&#34;</span><span class=p>:</span> <span class=s2>&#34;nics&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;at least one NIC is required&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>409 Conflict</strong> - Machine with the same NIC MAC address already exists:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;https://api.example.com/errors/duplicate-mac-address&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Duplicate MAC Address&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>409</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=s2>&#34;A machine with MAC address 52:54:00:12:34:56 already exists&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instance&#34;</span><span class=p>:</span> <span class=s2>&#34;/api/v1/machines&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mac_address&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;existing_machine_id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-a000-7000-8000-fedcba987650&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=notes>Notes</h2><ul><li>The machine ID is generated server-side (UUIDv7)</li><li>MAC addresses must be unique across all machines</li><li>All size/capacity values are in bytes</li><li>Clock frequency is in hertz</li></ul><h2 id=data-models>Data Models</h2><p>All data models are defined as Protocol Buffer (protobuf) messages and stored in Firestore.</p><h3 id=machine>Machine</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>CPU</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>manufacturer</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>clock_frequency</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// measured in hertz
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int64</span> <span class=n>cores</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>            <span class=c1>// number of cores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>MemoryModule</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>             <span class=c1>// measured in bytes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Accelerator</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>manufacturer</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>NIC</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>mac</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>             <span class=c1>// mac address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Drive</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>capacity</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>         <span class=c1>// capacity in bytes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Machine</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>              <span class=c1>// UUIDv7 machine identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=n>CPU</span> <span class=n>cpus</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>MemoryModule</span> <span class=n>memory_modules</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>Accelerator</span> <span class=n>accelerators</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>NIC</span> <span class=n>nics</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>Drive</span> <span class=n>drives</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ab6cbac66e8cf3fa0a5a8998d224f183>2.2 - GET /api/v1/machines</h1><div class=lead>List all registered machines</div><p>List all registered machines with optional filtering by MAC address.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;API: GET /api/v1/machines?mac=...
    API-&gt;&gt;DB: Query machines with filters
    DB--&gt;&gt;API: Machine list
    API--&gt;&gt;Client: 200 OK (machines list)</pre><h2 id=request>Request</h2><p><strong>Query Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>page</code></td><td>integer</td><td>No</td><td>Page number (1-indexed)</td><td>1</td></tr><tr><td><code>per_page</code></td><td>integer</td><td>No</td><td>Results per page (1-100)</td><td>20</td></tr><tr><td><code>mac</code></td><td>string</td><td>No</td><td>Filter by NIC MAC address</td><td>-</td></tr></tbody></table><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/machines?page=1&amp;per_page=20</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>machine.example.com</span>
</span></span></code></pre></div><p><strong>Example Request with MAC filter:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/machines?mac=52:54:00:12:34:56</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>machine.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;machines&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;cpus&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;manufacturer&#34;</span><span class=p>:</span> <span class=s2>&#34;Intel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;clock_frequency&#34;</span><span class=p>:</span> <span class=mi>2400000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;cores&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;memory_modules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;accelerators&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;nics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;mac&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;drives&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;capacity&#34;</span><span class=p>:</span> <span class=mi>500107862016</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pagination&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;page&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;per_page&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;total_pages&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5c3e0835220581b8bba64831f6f7f2be>2.3 - GET /api/v1/machines/{id}</h1><div class=lead>Retrieve a specific machine by ID</div><p>Retrieve a specific machine by ID.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;API: GET /api/v1/machines/{id}
    API-&gt;&gt;DB: Query machine by ID
    DB--&gt;&gt;API: Machine profile
    API--&gt;&gt;Client: 200 OK (machine profile)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/api/v1/machines/018c7dbd-c000-7000-8000-fedcba987654</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>machine.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpus&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;manufacturer&#34;</span><span class=p>:</span> <span class=s2>&#34;Intel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;clock_frequency&#34;</span><span class=p>:</span> <span class=mi>2400000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;cores&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;memory_modules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;accelerators&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;nics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;drives&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;capacity&#34;</span><span class=p>:</span> <span class=mi>500107862016</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified ID not found</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-469e776cf0ea53aa67c4999bef12df53>2.4 - PUT /api/v1/machines/{id}</h1><div class=lead>Update a machine&rsquo;s hardware profile</div><p>Update a machine&rsquo;s hardware profile.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;API: PUT /api/v1/machines/{id}
    API-&gt;&gt;DB: Update machine profile
    DB--&gt;&gt;API: Machine updated
    API--&gt;&gt;Client: 200 OK (updated profile)</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Request Body:</strong></p><p>Full machine profile (same structure as POST /api/v1/machines):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpus&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;manufacturer&#34;</span><span class=p>:</span> <span class=s2>&#34;Intel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;clock_frequency&#34;</span><span class=p>:</span> <span class=mi>2400000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;cores&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;memory_modules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;accelerators&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;nics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;drives&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;capacity&#34;</span><span class=p>:</span> <span class=mi>500107862016</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (200 OK):</strong></p><p>Full machine profile with updated fields:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;018c7dbd-c000-7000-8000-fedcba987654&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpus&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;manufacturer&#34;</span><span class=p>:</span> <span class=s2>&#34;Intel&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;clock_frequency&#34;</span><span class=p>:</span> <span class=mi>2400000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;cores&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;memory_modules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>17179869184</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;accelerators&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;nics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mac&#34;</span><span class=p>:</span> <span class=s2>&#34;52:54:00:12:34:56&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;drives&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;capacity&#34;</span><span class=p>:</span> <span class=mi>500107862016</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified ID not found</td></tr><tr><td>400 Bad Request</td><td>Invalid request body</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-8b6e001a582334f5057d88dd3d1a31c3>2.5 - DELETE /api/v1/machines/{id}</h1><div class=lead>Delete a machine registration</div><p>Delete a machine registration.</p><h2 id=sequence-diagram>Sequence Diagram</h2><pre class=mermaid>sequenceDiagram
    participant Client as Admin Client
    participant API as Machine Service
    participant DB as Firestore

    Client-&gt;&gt;API: DELETE /api/v1/machines/{id}
    API-&gt;&gt;DB: Delete machine by ID
    DB--&gt;&gt;API: Machine deleted
    API--&gt;&gt;Client: 204 No Content</pre><h2 id=request>Request</h2><p><strong>Path Parameters:</strong></p><table><thead><tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>string</td><td>Yes</td><td>Machine identifier (UUIDv7 format)</td></tr></tbody></table><p><strong>Example Request:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>DELETE</span> <span class=nn>/api/v1/machines/018c7dbd-c000-7000-8000-fedcba987654</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>machine.example.com</span>
</span></span></code></pre></div><h2 id=response>Response</h2><p><strong>Response (204 No Content):</strong></p><p>Empty response body.</p><p><strong>Error Responses:</strong></p><table><thead><tr><th>Status Code</th><th>Description</th></tr></thead><tbody><tr><td>404 Not Found</td><td>Machine with specified ID not found</td></tr></tbody></table></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/Zaba505/infra aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Zaba505 | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/infra/pr-preview/pr-626/js/main.min.eb40505784d893e4b5c8dbd67b59c353e735d847f4ffbfe9d6921dec08dbacba.js integrity="sha256-60BQV4TYk+S1yNvWe1nDU+c12Ef0/7/p1pId7AjbrLo=" crossorigin=anonymous></script><script defer src=/infra/pr-preview/pr-626/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/infra/pr-preview/pr-626/js/tabpane-persist.js></script></body></html>