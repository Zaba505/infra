<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/analysis/aws/><link rel=alternate type=application/rss+xml href=https://zaba505.github.io/infra/pr-preview/pr-626/rd/analysis/aws/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/infra/pr-preview/pr-626/favicons/favicon.ico><link rel=apple-touch-icon href=/infra/pr-preview/pr-626/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/infra/pr-preview/pr-626/favicons/android-192x192.png sizes=192x192><title>Amazon Web Services Analysis | Zaba505's Home Lab</title><meta name=description content="Technical analysis of Amazon Web Services capabilities for hosting network boot infrastructure"><meta property="og:url" content="https://zaba505.github.io/infra/pr-preview/pr-626/rd/analysis/aws/"><meta property="og:site_name" content="Zaba505's Home Lab"><meta property="og:title" content="Amazon Web Services Analysis"><meta property="og:description" content="Technical analysis of Amazon Web Services capabilities for hosting network boot infrastructure"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Amazon Web Services Analysis"><meta itemprop=description content="Technical analysis of Amazon Web Services capabilities for hosting network boot infrastructure"><meta itemprop=dateModified content="2025-11-21T02:55:40+00:00"><meta itemprop=wordCount content="129"><meta name=twitter:card content="summary"><meta name=twitter:title content="Amazon Web Services Analysis"><meta name=twitter:description content="Technical analysis of Amazon Web Services capabilities for hosting network boot infrastructure"><link rel=preload href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css as=style integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><link href=/infra/pr-preview/pr-626/scss/main.min.74eef40c5172b0e2f11bd9c3ea40dba66c2dc642ac5294c208f5dc9ff772c0e9.css rel=stylesheet integrity="sha256-dO70DFFysOLxG9nD6kDbpmwtxkKsUpTCCPXcn/dywOk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/infra/pr-preview/pr-626/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Zaba505's Home Lab</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/infra/pr-preview/pr-626/offline-search-index.81e860e14dfd030946e836b2ea6a2a25.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/infra/pr-preview/pr-626/rd/analysis/aws/>Return to the regular view of this page</a>.</p></div><h1 class=title>Amazon Web Services Analysis</h1><div class=lead>Technical analysis of Amazon Web Services capabilities for hosting network boot infrastructure</div><ul><li>1: <a href=#pg-284e5fccd8c32dbd4ae3bfdb2a6d41ff>AWS Network Boot Protocol Support</a></li><li>2: <a href=#pg-7800b35f37709f63e0f12019a82ee550>AWS WireGuard VPN Support</a></li></ul><div class=content><p>This section contains detailed analysis of Amazon Web Services (AWS) for hosting the network boot server infrastructure, evaluating its support for TFTP, HTTP/HTTPS routing, and WireGuard VPN connectivity as required by ADR-0002.</p><h2 id=overview>Overview</h2><p>Amazon Web Services is Amazon&rsquo;s comprehensive cloud computing platform, offering compute, storage, networking, and managed services. This analysis focuses on AWS&rsquo;s capabilities to support the network boot architecture decided in <a href=../../adrs/0002-network-boot-architecture/>ADR-0002</a>.</p><h2 id=key-services-evaluated>Key Services Evaluated</h2><ul><li><strong>EC2</strong>: Virtual machine instances for hosting boot server</li><li><strong>VPN / VPC</strong>: Network connectivity and VPN capabilities</li><li><strong>Elastic Load Balancing</strong>: Application and Network Load Balancers</li><li><strong>NAT Gateway</strong>: Network address translation for outbound connectivity</li><li><strong>VPC</strong>: Virtual Private Cloud networking and routing</li></ul><h2 id=documentation-sections>Documentation Sections</h2><ul><li><a href=./network-boot/>Network Boot Support</a> - Analysis of TFTP, HTTP, and HTTPS routing capabilities</li><li><a href=./wireguard/>WireGuard Support</a> - Evaluation of WireGuard VPN integration options</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-284e5fccd8c32dbd4ae3bfdb2a6d41ff>1 - AWS Network Boot Protocol Support</h1><div class=lead>Analysis of Amazon Web Services support for TFTP, HTTP, and HTTPS routing for network boot infrastructure</div><h1 id=network-boot-protocol-support-on-amazon-web-services>Network Boot Protocol Support on Amazon Web Services</h1><p>This document analyzes AWS&rsquo;s capabilities for hosting network boot infrastructure, specifically focusing on TFTP, HTTP, and HTTPS protocol support.</p><h2 id=tftp-trivial-file-transfer-protocol-support>TFTP (Trivial File Transfer Protocol) Support</h2><h3 id=native-support>Native Support</h3><p><strong>Status</strong>: ❌ <strong>Not natively supported by Elastic Load Balancing</strong></p><p>AWS&rsquo;s Elastic Load Balancing services do <strong>not</strong> support TFTP protocol natively:</p><ul><li><strong>Application Load Balancer (ALB)</strong>: HTTP/HTTPS only (Layer 7)</li><li><strong>Network Load Balancer (NLB)</strong>: TCP/UDP support, but <strong>not TFTP-aware</strong></li><li><strong>Classic Load Balancer</strong>: Deprecated, similar limitations</li></ul><p>TFTP operates on UDP port 69 with unique protocol semantics (variable block sizes, retransmissions, port negotiation) that standard load balancers cannot parse.</p><h3 id=implementation-options>Implementation Options</h3><h4 id=option-1-direct-ec2-instance-access-recommended-for-vpn-scenario>Option 1: Direct EC2 Instance Access (Recommended for VPN Scenario)</h4><p>Since ADR-0002 specifies a VPN-based architecture, TFTP can be served directly from an EC2 instance:</p><ul><li><strong>Approach</strong>: Run TFTP server (e.g., <code>tftpd-hpa</code>, <code>dnsmasq</code>) on an EC2 instance</li><li><strong>Access</strong>: Home lab connects via VPN tunnel to instance&rsquo;s private IP</li><li><strong>Security Group</strong>: Allow UDP/69 from VPN subnet/security group</li><li><strong>Pros</strong>:<ul><li>Simple implementation</li><li>No load balancer needed (single boot server sufficient for home lab)</li><li>TFTP traffic encrypted through VPN tunnel</li><li>Direct instance-to-client communication</li></ul></li><li><strong>Cons</strong>:<ul><li>Single point of failure (no HA)</li><li>Manual failover if instance fails</li></ul></li></ul><h4 id=option-2-network-load-balancer-nlb-udp-passthrough>Option 2: Network Load Balancer (NLB) UDP Passthrough</h4><p>While NLB doesn&rsquo;t understand TFTP protocol, it can forward UDP traffic:</p><ul><li><strong>Approach</strong>: Configure NLB to forward UDP/69 to target group</li><li><strong>Limitations</strong>:<ul><li>No TFTP-specific health checks</li><li>Health checks would use TCP or different protocol</li><li>Adds cost and complexity without significant benefit for single server</li></ul></li><li><strong>Use Case</strong>: Only relevant for multi-AZ HA deployment (overkill for home lab)</li></ul><h3 id=tftp-security-considerations>TFTP Security Considerations</h3><ul><li><strong>Encryption</strong>: TFTP itself is unencrypted, but VPN tunnel provides encryption</li><li><strong>Security Groups</strong>: Restrict UDP/69 to VPN security group or CIDR only</li><li><strong>File Access Control</strong>: Configure TFTP server with restricted file access</li><li><strong>Read-Only Mode</strong>: Deploy TFTP server in read-only mode to prevent uploads</li></ul><h2 id=http-support>HTTP Support</h2><h3 id=native-support-1>Native Support</h3><p><strong>Status</strong>: ✅ <strong>Fully supported</strong></p><p>AWS provides comprehensive HTTP support through multiple services:</p><h4 id=elastic-load-balancing---application-load-balancer>Elastic Load Balancing - Application Load Balancer</h4><ul><li><strong>Protocol Support</strong>: HTTP/1.1, HTTP/2, HTTP/3 (preview)</li><li><strong>Port</strong>: Any port (typically 80 for HTTP)</li><li><strong>Routing</strong>: Path-based, host-based, query string, header-based routing</li><li><strong>Health Checks</strong>: HTTP health checks with configurable paths and response codes</li><li><strong>SSL Offloading</strong>: Terminate SSL at ALB and use HTTP to backend</li><li><strong>Backend</strong>: EC2 instances, ECS, EKS, Lambda</li></ul><h4 id=ec2-direct-access>EC2 Direct Access</h4><p>For VPN scenario, HTTP can be served directly from EC2 instance:</p><ul><li><strong>Approach</strong>: Run HTTP server (nginx, Apache, custom service) on EC2</li><li><strong>Access</strong>: Home lab accesses via VPN tunnel to private IP</li><li><strong>Security Group</strong>: Allow TCP/80 from VPN security group</li><li><strong>Pros</strong>: Simpler than ALB for single boot server</li></ul><h3 id=http-boot-flow-for-network-boot>HTTP Boot Flow for Network Boot</h3><ol><li><strong>PXE → TFTP</strong>: Initial bootloader (iPXE) loaded via TFTP</li><li><strong>iPXE → HTTP</strong>: iPXE chainloads kernel/initrd via HTTP</li><li><strong>Kernel/Initrd</strong>: Large boot files served efficiently over HTTP</li></ol><h3 id=performance-considerations>Performance Considerations</h3><ul><li><strong>Connection Pooling</strong>: HTTP/1.1 keep-alive reduces connection overhead</li><li><strong>Compression</strong>: gzip compression for text-based configs</li><li><strong>CloudFront</strong>: Optional CDN for caching boot files (probably overkill for VPN scenario)</li><li><strong>TCP Optimization</strong>: AWS network optimized for low-latency TCP</li></ul><h2 id=https-support>HTTPS Support</h2><h3 id=native-support-2>Native Support</h3><p><strong>Status</strong>: ✅ <strong>Fully supported with advanced features</strong></p><p>AWS provides enterprise-grade HTTPS support:</p><h4 id=elastic-load-balancing---application-load-balancer-1>Elastic Load Balancing - Application Load Balancer</h4><ul><li><strong>Protocol Support</strong>: HTTPS/1.1, HTTP/2 over TLS, HTTP/3 (preview)</li><li><strong>SSL/TLS Termination</strong>: Terminate SSL at ALB</li><li><strong>Certificate Management</strong>:<ul><li>AWS Certificate Manager (ACM) - free SSL certificates with automatic renewal</li><li>Import custom certificates</li><li>Integration with private CA via ACM Private CA</li></ul></li><li><strong>TLS Versions</strong>: TLS 1.0, 1.1, 1.2, 1.3 (configurable via security policy)</li><li><strong>Cipher Suites</strong>: Predefined security policies (modern, compatible, legacy)</li><li><strong>SNI Support</strong>: Multiple certificates on single load balancer</li></ul><h4 id=aws-certificate-manager-acm>AWS Certificate Manager (ACM)</h4><ul><li><strong>Free Certificates</strong>: No cost for public SSL certificates used with AWS services</li><li><strong>Automatic Renewal</strong>: ACM automatically renews certificates before expiration</li><li><strong>Private CA</strong>: ACM Private CA for internal PKI (additional cost)</li><li><strong>Integration</strong>: Native integration with ALB, CloudFront, API Gateway</li></ul><h3 id=https-for-network-boot>HTTPS for Network Boot</h3><h4 id=use-case>Use Case</h4><p>Modern UEFI firmware and iPXE support HTTPS boot:</p><ul><li><strong>iPXE HTTPS</strong>: iPXE compiled with <code>DOWNLOAD_PROTO_HTTPS</code> can fetch over HTTPS</li><li><strong>UEFI HTTP Boot</strong>: UEFI firmware natively supports HTTP/HTTPS boot</li><li><strong>Security</strong>: Boot file integrity verified via HTTPS chain of trust</li></ul><h4 id=implementation-on-aws>Implementation on AWS</h4><ol><li><p><strong>Certificate Provisioning</strong>:</p><ul><li>Use ACM certificate for public domain (free, auto-renewed)</li><li>Use self-signed certificate for VPN-only access (add to iPXE trust store)</li><li>Use ACM Private CA for internal PKI ($400/month - expensive for home lab)</li></ul></li><li><p><strong>ALB Configuration</strong>:</p><ul><li>HTTPS listener on port 443</li><li>Target group pointing to EC2 boot server</li><li>Security policy with TLS 1.2+ minimum</li></ul></li><li><p><strong>Alternative: Direct EC2 HTTPS</strong>:</p><ul><li>Run nginx/Apache with TLS on EC2 instance</li><li>Access via VPN tunnel to private IP with HTTPS</li><li>Simpler setup for VPN-only scenario</li><li>Use Let&rsquo;s Encrypt or self-signed certificate</li></ul></li></ol><h3 id=mutual-tls-mtls-support>Mutual TLS (mTLS) Support</h3><p>AWS ALB supports mutual TLS authentication (as of 2022):</p><ul><li><strong>Client Certificates</strong>: Require client certificates for authentication</li><li><strong>Trust Store</strong>: Upload trusted CA certificates to ALB</li><li><strong>Use Case</strong>: Ensure only authorized home lab servers can access boot files</li><li><strong>Integration</strong>: Combine with VPN for defense-in-depth</li><li><strong>Passthrough Mode</strong>: ALB can pass client cert to backend for validation</li></ul><h2 id=routing-and-load-balancing-capabilities>Routing and Load Balancing Capabilities</h2><h3 id=vpc-routing>VPC Routing</h3><ul><li><strong>Route Tables</strong>: Define routes to direct traffic through VPN gateway</li><li><strong>Route Propagation</strong>: BGP route propagation for VPN connections</li><li><strong>Transit Gateway</strong>: Advanced multi-VPC/VPN routing (overkill for home lab)</li></ul><h3 id=security-groups>Security Groups</h3><ul><li><strong>Stateful Firewall</strong>: Automatic return traffic handling</li><li><strong>Ingress/Egress Rules</strong>: Fine-grained control by protocol, port, source/destination</li><li><strong>Security Group Chaining</strong>: Reference security groups in rules (elegant for VPN setup)</li><li><strong>VPN Subnet Restriction</strong>: Allow traffic only from VPN-connected subnet</li></ul><h3 id=network-acls-optional>Network ACLs (Optional)</h3><ul><li><strong>Stateless Firewall</strong>: Subnet-level access control</li><li><strong>Defense in Depth</strong>: Additional layer beyond security groups</li><li><strong>Use Case</strong>: Probably unnecessary for simple VPN boot server</li></ul><h2 id=cost-implications>Cost Implications</h2><h3 id=data-transfer-costs>Data Transfer Costs</h3><ul><li><strong>VPN Traffic</strong>: Data transfer through VPN gateway charged at standard rates</li><li><strong>Intra-Region</strong>: Free for traffic within same region/VPC</li><li><strong>Boot File Sizes</strong>: Typical kernel + initrd = 50-200MB per boot</li><li><strong>Monthly Estimate</strong>: 10 boots/month × 150MB = 1.5GB ≈ $0.14/month (US East egress)</li></ul><h3 id=load-balancing-costs>Load Balancing Costs</h3><ul><li><strong>Application Load Balancer</strong>: <del>$0.0225/hour + $0.008 per LCU-hour (</del>$16-20/month minimum)</li><li><strong>Network Load Balancer</strong>: <del>$0.0225/hour + $0.006 per NLCU-hour (</del>$16-18/month minimum)</li><li><strong>For VPN Scenario</strong>: Load balancer unnecessary (single EC2 instance sufficient)</li></ul><h3 id=compute-costs>Compute Costs</h3><ul><li><strong>t3.micro Instance</strong>: ~$7.50/month (on-demand pricing, US East)</li><li><strong>t4g.micro Instance</strong>: ~$6.00/month (ARM-based, cheaper, sufficient for boot server)</li><li><strong>Reserved Instances</strong>: Up to 72% savings with 1-year or 3-year commitment</li><li><strong>Savings Plans</strong>: Flexible discounts for consistent compute usage</li></ul><h3 id=acm-certificate-costs>ACM Certificate Costs</h3><ul><li><strong>Public Certificates</strong>: <strong>Free</strong> when used with AWS services</li><li><strong>Private CA</strong>: $400/month (too expensive for home lab)</li></ul><h2 id=comparison-with-requirements>Comparison with Requirements</h2><table><thead><tr><th>Requirement</th><th>AWS Support</th><th>Implementation</th></tr></thead><tbody><tr><td>TFTP</td><td>⚠️ Via EC2, not ELB</td><td>Direct EC2 access via VPN</td></tr><tr><td>HTTP</td><td>✅ Full support</td><td>EC2 or ALB</td></tr><tr><td>HTTPS</td><td>✅ Full support</td><td>EC2 or ALB with ACM</td></tr><tr><td>VPN Integration</td><td>✅ Native VPN</td><td>Site-to-Site VPN or self-managed</td></tr><tr><td>Load Balancing</td><td>✅ ALB, NLB</td><td>Optional for HA</td></tr><tr><td>Certificate Mgmt</td><td>✅ ACM (free)</td><td>Automatic renewal</td></tr><tr><td>Cost Efficiency</td><td>✅ Low-cost instances</td><td>t4g.micro sufficient</td></tr></tbody></table><h2 id=recommendations>Recommendations</h2><h3 id=for-vpn-based-architecture-per-adr-0002>For VPN-Based Architecture (per ADR-0002)</h3><ol><li><p><strong>EC2 Instance</strong>: Deploy single t4g.micro or t3.micro instance with:</p><ul><li>TFTP server (<code>tftpd-hpa</code> or <code>dnsmasq</code>)</li><li>HTTP server (nginx or simple Python HTTP server)</li><li>Optional HTTPS with Let&rsquo;s Encrypt or self-signed certificate</li></ul></li><li><p><strong>VPN Connection</strong>: Connect home lab to AWS via:</p><ul><li>Site-to-Site VPN (IPsec) - managed service, higher cost (~$36/month)</li><li>Self-managed WireGuard on EC2 - lower cost, more control</li></ul></li><li><p><strong>Security Groups</strong>: Restrict access to:</p><ul><li>UDP/69 (TFTP) from VPN security group only</li><li>TCP/80 (HTTP) from VPN security group only</li><li>TCP/443 (HTTPS) from VPN security group only</li></ul></li><li><p><strong>No Load Balancer</strong>: For home lab scale, direct EC2 access is sufficient</p></li><li><p><strong>Health Monitoring</strong>: Use CloudWatch for instance and service health</p></li></ol><h3 id=if-ha-required-future-enhancement>If HA Required (Future Enhancement)</h3><ul><li>Deploy multi-AZ EC2 instances with Network Load Balancer</li><li>Use S3 as backend for boot files with EC2 serving as cache</li><li>Implement auto-recovery with Auto Scaling Group (min=max=1)</li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.aws.amazon.com/elasticloadbalancing/>AWS Elastic Load Balancing Documentation</a></li><li><a href=https://docs.aws.amazon.com/acm/>AWS Certificate Manager</a></li><li><a href=https://docs.aws.amazon.com/vpn/>AWS Site-to-Site VPN</a></li><li><a href=https://ipxe.org/crypto>iPXE HTTPS Boot</a></li><li><a href=https://uefi.org/specs/UEFI/2.10/24_Network_Protocols.html#http-boot>UEFI HTTP Boot Specification</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7800b35f37709f63e0f12019a82ee550>2 - AWS WireGuard VPN Support</h1><div class=lead>Analysis of WireGuard VPN deployment options on Amazon Web Services for secure site-to-site connectivity</div><h1 id=wireguard-vpn-support-on-amazon-web-services>WireGuard VPN Support on Amazon Web Services</h1><p>This document analyzes options for deploying WireGuard VPN on AWS to establish secure site-to-site connectivity between the home lab and cloud-hosted network boot infrastructure.</p><h2 id=wireguard-overview>WireGuard Overview</h2><p>WireGuard is a modern VPN protocol that provides:</p><ul><li><strong>Simplicity</strong>: Minimal codebase (~4,000 lines vs 100,000+ for IPsec)</li><li><strong>Performance</strong>: High throughput with low overhead</li><li><strong>Security</strong>: Modern cryptography (Curve25519, ChaCha20, Poly1305, BLAKE2s)</li><li><strong>Configuration</strong>: Simple key-based configuration</li><li><strong>Kernel Integration</strong>: Mainline Linux kernel support since 5.6</li></ul><h2 id=aws-native-vpn-support>AWS Native VPN Support</h2><h3 id=site-to-site-vpn-ipsec>Site-to-Site VPN (IPsec)</h3><p><strong>Status</strong>: ❌ <strong>WireGuard not natively supported</strong></p><p>AWS&rsquo;s managed Site-to-Site VPN supports:</p><ul><li><strong>IPsec VPN</strong>: IKEv1, IKEv2 with pre-shared keys</li><li><strong>Redundancy</strong>: Two VPN tunnels per connection for high availability</li><li><strong>BGP Support</strong>: Dynamic routing via BGP</li><li><strong>Transit Gateway</strong>: Scalable multi-VPC VPN hub</li></ul><p><strong>Limitation</strong>: Site-to-Site VPN does <strong>not</strong> support WireGuard protocol natively.</p><h3 id=cost-site-to-site-vpn>Cost: Site-to-Site VPN</h3><ul><li><strong>VPN Connection</strong>: ~$0.05/hour = ~$36/month</li><li><strong>Data Transfer</strong>: Standard data transfer out rates (~$0.09/GB for first 10TB)</li><li><strong>Total Estimate</strong>: ~$36-50/month for managed IPsec VPN</li></ul><h2 id=self-managed-wireguard-on-ec2>Self-Managed WireGuard on EC2</h2><h3 id=implementation-approach>Implementation Approach</h3><p>Since AWS doesn&rsquo;t offer managed WireGuard, deploy WireGuard on an EC2 instance:</p><p><strong>Status</strong>: ✅ <strong>Fully supported via EC2</strong></p><h4 id=architecture>Architecture</h4><pre class=mermaid>graph LR
    A[Home Lab] --&gt;|WireGuard Tunnel| B[AWS EC2 Instance]
    B --&gt;|VPC Network| C[Boot Server EC2]
    B --&gt;|IP Forwarding| C
    
    subgraph &#34;Home Network&#34;
        A
        D[UDM Pro]
        D -.WireGuard Client.- A
    end
    
    subgraph &#34;AWS VPC&#34;
        B[WireGuard Gateway EC2]
        C[Boot Server EC2]
    end</pre><h4 id=ec2-configuration>EC2 Configuration</h4><ol><li><p><strong>WireGuard Gateway Instance</strong>:</p><ul><li><strong>Instance Type</strong>: t4g.micro or t3.micro ($6-7.50/month)</li><li><strong>OS</strong>: Ubuntu 22.04 LTS or Amazon Linux 2023 (native WireGuard support)</li><li><strong>Source/Dest Check</strong>: <strong>Disable</strong> to allow IP forwarding</li><li><strong>Elastic IP</strong>: Allocate Elastic IP for stable WireGuard endpoint</li><li><strong>Security Group</strong>: Allow UDP port 51820 from home lab public IP</li></ul></li><li><p><strong>Boot Server Instance</strong>:</p><ul><li><strong>Network</strong>: Same VPC as WireGuard gateway</li><li><strong>Private IP Only</strong>: No Elastic IP (accessed via VPN)</li><li><strong>Route Traffic</strong>: Through WireGuard gateway instance</li></ul></li></ol><h4 id=installation-steps>Installation Steps</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># On EC2 Instance (Ubuntu 22.04+)</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install wireguard wireguard-tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Generate server keys</span>
</span></span><span style=display:flex><span>wg genkey <span style=color:#000;font-weight:700>|</span> tee /etc/wireguard/server_private.key <span style=color:#000;font-weight:700>|</span> wg pubkey &gt; /etc/wireguard/server_public.key
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure WireGuard interface</span>
</span></span><span style=display:flex><span>sudo nano /etc/wireguard/wg0.conf
</span></span></code></pre></div><p><strong>Example <code>/etc/wireguard/wg0.conf</code> on AWS EC2</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.1/24</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>ListenPort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>51820</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PrivateKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;SERVER_PRIVATE_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>sysctl -w net.ipv4.ip_forward=1</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -A FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostUp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostDown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -D FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PostDown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Home Lab (UDM Pro)</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PublicKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;CLIENT_PUBLIC_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AllowedIPs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.2/32, 192.168.1.0/24</span>
</span></span></code></pre></div><p><strong>Corresponding config on UDM Pro</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.2/24</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PrivateKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;CLIENT_PRIVATE_KEY&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PublicKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;SERVER_PUBLIC_KEY&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Endpoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&lt;AWS_ELASTIC_IP&gt;:51820</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AllowedIPs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>10.200.0.0/24, 10.0.0.0/16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>PersistentKeepalive</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>25</span>
</span></span></code></pre></div><h4 id=enable-and-start-wireguard>Enable and Start WireGuard</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable IP forwarding permanently</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;net.ipv4.ip_forward=1&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span>sudo sysctl -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable WireGuard interface</span>
</span></span><span style=display:flex><span>sudo systemctl <span style=color:#204a87>enable</span> wg-quick@wg0
</span></span><span style=display:flex><span>sudo systemctl start wg-quick@wg0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Verify status</span>
</span></span><span style=display:flex><span>sudo wg show
</span></span></code></pre></div><h3 id=aws-vpc-configuration>AWS VPC Configuration</h3><h4 id=security-groups>Security Groups</h4><p>Create security group for WireGuard gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 create-security-group <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --group-name wireguard-gateway-sg <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --description <span style=color:#4e9a06>&#34;WireGuard VPN gateway&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --vpc-id vpc-xxxxxx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws ec2 authorize-security-group-ingress <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --group-id sg-xxxxxx <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --protocol udp <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --port <span style=color:#0000cf;font-weight:700>51820</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cidr &lt;HOME_LAB_PUBLIC_IP&gt;/32
</span></span></code></pre></div><p>Allow SSH for management (optional, restrict to trusted IP):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 authorize-security-group-ingress <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --group-id sg-xxxxxx <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --protocol tcp <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --port <span style=color:#0000cf;font-weight:700>22</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cidr &lt;TRUSTED_IP&gt;/32
</span></span></code></pre></div><h4 id=disable-sourcedestination-check>Disable Source/Destination Check</h4><p>Required for IP forwarding to work:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 modify-instance-attribute <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --instance-id i-xxxxxx <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --no-source-dest-check
</span></span></code></pre></div><h4 id=elastic-ip-allocation>Elastic IP Allocation</h4><p>Allocate and associate Elastic IP for stable endpoint:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 allocate-address --domain vpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws ec2 associate-address <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --instance-id i-xxxxxx <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --allocation-id eipalloc-xxxxxx
</span></span></code></pre></div><p><strong>Cost</strong>: Elastic IP is <strong>free</strong> when associated with running instance, but charged ~$3.60/month if unattached.</p><h4 id=route-table-configuration>Route Table Configuration</h4><p>Add route to direct home lab subnet traffic through WireGuard gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ec2 create-route <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --route-table-id rtb-xxxxxx <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --destination-cidr-block 192.168.1.0/24 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --instance-id i-xxxxxx
</span></span></code></pre></div><p>This routes home lab subnet (192.168.1.0/24) through the WireGuard gateway instance.</p><h2 id=udm-pro-wireguard-integration>UDM Pro WireGuard Integration</h2><h3 id=native-support>Native Support</h3><p><strong>Status</strong>: ✅ <strong>WireGuard supported natively</strong> (UniFi OS 1.12.22+)</p><p>The UniFi Dream Machine Pro includes native WireGuard VPN support:</p><ul><li><strong>GUI Configuration</strong>: Web UI for WireGuard VPN setup</li><li><strong>Site-to-Site</strong>: Support for site-to-site VPN tunnels</li><li><strong>Performance</strong>: Hardware acceleration for encryption (if available)</li><li><strong>Routing</strong>: Automatic route injection for remote subnets</li></ul><h3 id=configuration-steps-on-udm-pro>Configuration Steps on UDM Pro</h3><ol><li><p><strong>Network Settings → VPN</strong>:</p><ul><li>Create new VPN connection</li><li>Select &ldquo;WireGuard&rdquo;</li><li>Generate key pair or import existing</li></ul></li><li><p><strong>Peer Configuration</strong>:</p><ul><li><strong>Peer Public Key</strong>: AWS EC2 WireGuard instance&rsquo;s public key</li><li><strong>Endpoint</strong>: AWS Elastic IP address</li><li><strong>Port</strong>: 51820</li><li><strong>Allowed IPs</strong>: AWS VPC CIDR (e.g., 10.0.0.0/16)</li><li><strong>Persistent Keepalive</strong>: 25 seconds</li></ul></li><li><p><strong>Route Injection</strong>:</p><ul><li>UDM Pro automatically adds routes to AWS subnets</li><li>Home lab servers can reach AWS boot server via VPN</li></ul></li><li><p><strong>Firewall Rules</strong>:</p><ul><li>Add firewall rule to allow boot traffic (TFTP, HTTP) from LAN to VPN</li></ul></li></ol><h3 id=alternative-manual-wireguard-on-udm-pro>Alternative: Manual WireGuard on UDM Pro</h3><p>If native support is insufficient, use <code>wireguard-go</code> via <code>udm-utilities</code>:</p><ul><li><strong>Repository</strong>: <a href=https://github.com/boostchicken/udm-utilities>boostchicken/udm-utilities</a></li><li><strong>Script</strong>: <code>on_boot.d</code> script to start WireGuard on boot</li><li><strong>Persistence</strong>: Survives firmware updates with on-boot script</li></ul><h2 id=performance-considerations>Performance Considerations</h2><h3 id=throughput>Throughput</h3><p>WireGuard on EC2 performance varies by instance type:</p><ul><li><strong>t4g.micro</strong> (2 vCPU, ARM): ~100-300 Mbps</li><li><strong>t3.micro</strong> (2 vCPU, x86): ~100-300 Mbps</li><li><strong>t3.small</strong> (2 vCPU): ~500-800 Mbps</li><li><strong>t3.medium</strong> (2 vCPU): ~1+ Gbps</li></ul><p>For network boot (typical boot = 50-200MB), even t4g.micro is sufficient:</p><ul><li><strong>Boot Time</strong>: 150MB at 100 Mbps = ~12 seconds transfer time</li><li><strong>Recommendation</strong>: t4g.micro adequate and most cost-effective</li></ul><h3 id=latency>Latency</h3><ul><li><strong>VPN Overhead</strong>: WireGuard adds minimal latency (~1-5ms)</li><li><strong>AWS Network</strong>: Low-latency network infrastructure</li><li><strong>Total Latency</strong>: Primarily dependent on home ISP and AWS region proximity</li></ul><h3 id=cpu-usage>CPU Usage</h3><ul><li><strong>Encryption</strong>: ChaCha20 is CPU-efficient</li><li><strong>Kernel Module</strong>: Minimal CPU overhead in kernel space</li><li><strong>t4g.micro</strong>: Sufficient CPU for home lab VPN throughput</li><li><strong>ARM Advantage</strong>: t4g instances use Graviton processors (better price/performance)</li></ul><h2 id=security-considerations>Security Considerations</h2><h3 id=key-management>Key Management</h3><ul><li><strong>Private Keys</strong>: Store securely, never commit to version control</li><li><strong>Key Rotation</strong>: Rotate keys periodically (e.g., annually)</li><li><strong>Secrets Manager</strong>: Store WireGuard private keys in AWS Secrets Manager<ul><li>Retrieve at instance startup via user data script</li><li>Avoid storing in AMIs or instance metadata</li></ul></li><li><strong>IAM Role</strong>: Grant EC2 instance IAM role to read secret</li></ul><h3 id=firewall-hardening>Firewall Hardening</h3><ul><li><strong>Security Group Restriction</strong>: Limit WireGuard port to home lab public IP only</li><li><strong>Least Privilege</strong>: Boot server security group allows only VPN security group</li><li><strong>No Public Access</strong>: Boot server has no Elastic IP or public route</li></ul><h3 id=monitoring-and-alerts>Monitoring and Alerts</h3><ul><li><strong>CloudWatch Logs</strong>: Stream WireGuard logs to CloudWatch</li><li><strong>CloudWatch Alarms</strong>: Alert on VPN tunnel down (no recent handshakes)</li><li><strong>VPC Flow Logs</strong>: Monitor VPN traffic patterns</li></ul><h3 id=ddos-protection>DDoS Protection</h3><ul><li><strong>UDP Amplification</strong>: WireGuard resistant to DDoS amplification attacks</li><li><strong>AWS Shield</strong>: Basic DDoS protection included free on all AWS resources</li><li><strong>Shield Advanced</strong>: Optional ($3,000/month - overkill for VPN endpoint)</li></ul><h2 id=high-availability-options>High Availability Options</h2><h3 id=multi-az-failover>Multi-AZ Failover</h3><p>Deploy WireGuard gateways in multiple Availability Zones:</p><ul><li><strong>Primary</strong>: us-east-1a WireGuard instance</li><li><strong>Secondary</strong>: us-east-1b WireGuard instance</li><li><strong>Failover</strong>: UDM Pro switches endpoints if primary fails</li><li><strong>Cost</strong>: Doubles instance costs (~$12-15/month for 2 instances)</li></ul><h3 id=auto-scaling-group-single-instance>Auto Scaling Group (Single Instance)</h3><p>Use Auto Scaling Group with min=max=1 for auto-recovery:</p><ul><li><strong>Health Checks</strong>: EC2 status checks</li><li><strong>Auto-Recovery</strong>: ASG replaces failed instance automatically</li><li><strong>Elastic IP</strong>: Reassociate Elastic IP to new instance via Lambda/script</li><li><strong>Limitation</strong>: Brief downtime during recovery (~2-5 minutes)</li></ul><h3 id=health-monitoring>Health Monitoring</h3><p>Monitor WireGuard tunnel health with CloudWatch custom metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># On EC2 instance, run periodically via cron</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#000>HANDSHAKE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>wg show wg0 latest-handshakes <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{print $2}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>NOW</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>date +%s<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>AGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$((</span>NOW <span style=color:#ce5c00;font-weight:700>-</span> HANDSHAKE<span style=color:#204a87;font-weight:700>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws cloudwatch put-metric-data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --namespace WireGuard <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --metric-name TunnelAge <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --value <span style=color:#000>$AGE</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --unit Seconds
</span></span></code></pre></div><p>Alert if handshake age exceeds threshold (e.g., 180 seconds).</p><h3 id=user-data-script-for-auto-configuration>User Data Script for Auto-Configuration</h3><p>EC2 user data script to configure WireGuard on launch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># Install WireGuard</span>
</span></span><span style=display:flex><span>apt update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt install -y wireguard wireguard-tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Retrieve private key from Secrets Manager</span>
</span></span><span style=display:flex><span>aws secretsmanager get-secret-value <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --secret-id wireguard-server-key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --query SecretString <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --output text &gt; /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> /etc/wireguard/server_private.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure interface (full config omitted for brevity)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable and start WireGuard</span>
</span></span><span style=display:flex><span>systemctl <span style=color:#204a87>enable</span> wg-quick@wg0
</span></span><span style=display:flex><span>systemctl start wg-quick@wg0
</span></span></code></pre></div><p>Requires IAM instance role with <code>secretsmanager:GetSecretValue</code> permission.</p><h2 id=cost-analysis>Cost Analysis</h2><h3 id=self-managed-wireguard-on-ec2-1>Self-Managed WireGuard on EC2</h3><table><thead><tr><th>Component</th><th>Cost (US East)</th></tr></thead><tbody><tr><td>t4g.micro instance (730 hrs/month)</td><td>~$6.00</td></tr><tr><td>Elastic IP (attached)</td><td>$0.00</td></tr><tr><td>Data transfer out (1GB/month)</td><td>~$0.09</td></tr><tr><td><strong>Monthly Total</strong></td><td><strong>~$6.09</strong></td></tr><tr><td><strong>Annual Total</strong></td><td><strong>~$73</strong></td></tr></tbody></table><p>With Reserved Instance (1-year, no upfront):</p><table><thead><tr><th>Component</th><th>Cost</th></tr></thead><tbody><tr><td>t4g.micro RI (1-year)</td><td>~$3.50/month</td></tr><tr><td>Elastic IP</td><td>$0.00</td></tr><tr><td>Data transfer</td><td>~$0.09</td></tr><tr><td><strong>Monthly Total</strong></td><td><strong>~$3.59</strong></td></tr><tr><td><strong>Annual Total</strong></td><td><strong>~$43</strong></td></tr></tbody></table><h3 id=site-to-site-vpn-ipsec---if-wireguard-not-used>Site-to-Site VPN (IPsec - if WireGuard not used)</h3><table><thead><tr><th>Component</th><th>Cost</th></tr></thead><tbody><tr><td>VPN Connection (2 tunnels)</td><td>~$36</td></tr><tr><td>Data transfer (1GB/month)</td><td>~$0.09</td></tr><tr><td><strong>Monthly Total</strong></td><td><strong>~$36</strong></td></tr><tr><td><strong>Annual Total</strong></td><td><strong>~$432</strong></td></tr></tbody></table><p><strong>Cost Savings</strong>: Self-managed WireGuard saves <strong>~$360/year</strong> vs Site-to-Site VPN (or <strong>~$390/year</strong> with Reserved Instance).</p><h2 id=comparison-with-requirements>Comparison with Requirements</h2><table><thead><tr><th>Requirement</th><th>AWS Support</th><th>Implementation</th></tr></thead><tbody><tr><td>WireGuard Protocol</td><td>✅ Via EC2</td><td>Self-managed on instance</td></tr><tr><td>Site-to-Site VPN</td><td>✅ Yes</td><td>WireGuard tunnel</td></tr><tr><td>UDM Pro Integration</td><td>✅ Native support</td><td>WireGuard peer config</td></tr><tr><td>Cost Efficiency</td><td>✅ Very low cost</td><td>t4g.micro ~$6/month (on-demand)</td></tr><tr><td>Performance</td><td>✅ Sufficient</td><td>100+ Mbps on t4g.micro</td></tr><tr><td>Security</td><td>✅ Modern crypto</td><td>ChaCha20, Curve25519</td></tr><tr><td>HA (optional)</td><td>⚠️ Manual setup</td><td>Multi-AZ or ASG</td></tr></tbody></table><h2 id=recommendations>Recommendations</h2><h3 id=for-home-lab-vpn-per-adr-0002>For Home Lab VPN (per ADR-0002)</h3><ol><li><p><strong>Self-Managed WireGuard</strong>: Deploy on EC2 t4g.micro instance</p><ul><li><strong>Cost</strong>: ~$6/month on-demand, ~$3.50/month with Reserved Instance</li><li><strong>Performance</strong>: Sufficient for network boot traffic</li><li><strong>Simplicity</strong>: Easy to configure and maintain</li></ul></li><li><p><strong>Single AZ Deployment</strong>: Unless HA required, single instance adequate</p><ul><li><strong>Region Selection</strong>: Choose region closest to home lab for lowest latency</li><li><strong>AZ</strong>: Single AZ sufficient (boot server not mission-critical)</li></ul></li><li><p><strong>UDM Pro Native WireGuard</strong>: Use built-in WireGuard client</p><ul><li><strong>Configuration</strong>: Add AWS instance as WireGuard peer in UDM Pro UI</li><li><strong>Route Injection</strong>: UDM Pro automatically routes AWS subnets</li></ul></li><li><p><strong>Security Best Practices</strong>:</p><ul><li>Store WireGuard private key in Secrets Manager</li><li>Restrict security group to home lab public IP only</li><li>Use user data script to retrieve key and configure on boot</li><li>Enable CloudWatch logging for VPN events</li><li>Assign IAM instance role with minimal permissions</li></ul></li><li><p><strong>Monitoring</strong>: Set up CloudWatch alarms for:</p><ul><li>Instance status check failures</li><li>High CPU usage</li><li>VPN tunnel age (custom metric)</li></ul></li></ol><h3 id=cost-optimization>Cost Optimization</h3><ul><li><strong>Reserved Instance</strong>: Commit to 1-year Reserved Instance for ~40% savings</li><li><strong>Spot Instance</strong>: Consider Spot for even lower cost (~70% savings), but adds complexity (handle interruptions)</li><li><strong>ARM Architecture</strong>: Use t4g (Graviton) for 20% better price/performance vs t3</li></ul><h3 id=future-enhancements>Future Enhancements</h3><ul><li><strong>HA Setup</strong>: Deploy secondary WireGuard instance in different AZ</li><li><strong>Automated Failover</strong>: Lambda function to reassociate Elastic IP on failure</li><li><strong>IPv6 Support</strong>: Enable WireGuard over IPv6 if home ISP supports</li><li><strong>Mesh VPN</strong>: Expand to mesh topology if multiple sites added</li></ul><h2 id=references>References</h2><ul><li><a href=https://www.wireguard.com/>WireGuard Official Site</a></li><li><a href=https://ubuntu.com/server/docs/wireguard-vpn>WireGuard on Ubuntu</a></li><li><a href=https://docs.aws.amazon.com/vpc/latest/userguide/VPC_NAT_Instance.html#EIP_Disable_SrcDestCheck>AWS EC2 IP Forwarding (Disable Source/Dest Check)</a></li><li><a href=https://help.ui.com/hc/en-us/articles/115015971688>UniFi WireGuard VPN</a></li><li><a href=https://github.com/boostchicken/udm-utilities>udm-utilities GitHub</a></li><li><a href=https://docs.aws.amazon.com/secretsmanager/>AWS Secrets Manager</a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/Zaba505/infra aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Zaba505 | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/infra/pr-preview/pr-626/js/main.min.eb40505784d893e4b5c8dbd67b59c353e735d847f4ffbfe9d6921dec08dbacba.js integrity="sha256-60BQV4TYk+S1yNvWe1nDU+c12Ef0/7/p1pId7AjbrLo=" crossorigin=anonymous></script><script defer src=/infra/pr-preview/pr-626/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/infra/pr-preview/pr-626/js/tabpane-persist.js></script></body></html>